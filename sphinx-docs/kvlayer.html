<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>6. kvlayer — database abstraction for key/value stores &mdash; streamcorpus-pipeline 0.7.10.dev1 documentation</title>
    
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.7.10.dev1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="streamcorpus-pipeline 0.7.10.dev1 documentation" href="../index.html" />
    <link rel="next" title="7. rejester — Redis-based distributed work manager" href="rejester.html" />
    <link rel="prev" title="5. dblogger — Python logging setup and database backend" href="dblogger.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="rejester.html" title="7. rejester — Redis-based distributed work manager"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="dblogger.html" title="5. dblogger — Python logging setup and database backend"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">streamcorpus-pipeline 0.7.10.dev1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="module-kvlayer">
<span id="kvlayer-database-abstraction-for-key-value-stores"></span><h1>6. <a class="reference internal" href="#module-kvlayer" title="kvlayer"><code class="xref py py-mod docutils literal"><span class="pre">kvlayer</span></code></a> &#8212; database abstraction for key/value stores<a class="headerlink" href="#module-kvlayer" title="Permalink to this headline">¶</a></h1>
<p>Database abstraction for key/value stores.</p>
<p>Many popular large-scale databases export a simple key/value
abstraction: the database is simply a list of cells with some
(possibly structured) key and a value for each key.  This allows the
database system itself to partition the database in some way, and in a
distributed system it allows the correct system hosting a specific key
to be found easily.  This model is also simple enough that it can be
used with in-memory storage or more traditional SQL-based databases.</p>
<p>This module provides a simple abstraction around these
key/value-oriented databases.  It works with <a class="reference internal" href="yakonfig.html#module-yakonfig" title="yakonfig"><code class="xref py py-mod docutils literal"><span class="pre">yakonfig</span></code></a> to hold
basic configuration settings, so the top-level YAML configuration must
have a <code class="docutils literal"><span class="pre">kvlayer</span></code> block.  This will typically look something like</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">kvlayer</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">storage_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">redis</span>
  <span class="l-Scalar-Plain">storage_addresses</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">redis.example.com</span><span class="p-Indicator">:</span><span class="nv">6379</span><span class="p-Indicator">]</span>
  <span class="l-Scalar-Plain">app_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">app</span>
  <span class="l-Scalar-Plain">namespace</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">namespace</span>
</pre></div>
</div>
<p>These four parameters are always required.  <code class="docutils literal"><span class="pre">storage_type</span></code> gives one
of the database backends described below.  <code class="docutils literal"><span class="pre">storage_addresses</span></code> is a
list of backend-specific database locations.  <code class="docutils literal"><span class="pre">app_name</span></code> and
<code class="docutils literal"><span class="pre">namespace</span></code> combine to form a container for the virtual tables
stored in kvlayer.</p>
<p>Backend-specific configuration may also be broken into a separate
section, whose name matches the <code class="docutils literal"><span class="pre">storage_type</span></code>:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">kvlayer</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">storage_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">redis</span>
  <span class="l-Scalar-Plain">redis</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">storage_addresses</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">redis.example.com</span><span class="p-Indicator">:</span><span class="nv">6379</span><span class="p-Indicator">]</span>
    <span class="l-Scalar-Plain">app_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">app</span>
    <span class="l-Scalar-Plain">namespace</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">namespace</span>
</pre></div>
</div>
<p>This is useful if experimenting with different backends, or with the
<code class="docutils literal"><span class="pre">split_s3</span></code> hybrid backend.  Any configuration value may be in either
the backend-specific configuration or the top-level kvlayer
configuration, with deeper values taking precedence.</p>
<div class="section" id="backends">
<h2>6.1. Backends<a class="headerlink" href="#backends" title="Permalink to this headline">¶</a></h2>
<div class="section" id="local">
<h3>6.1.1. local<a class="headerlink" href="#local" title="Permalink to this headline">¶</a></h3>
<p>This is intended only for testing.  Values are stored in a Python
dictionary and not persisted.  <code class="docutils literal"><span class="pre">storage_addresses</span></code> are not required.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">kvlayer</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">storage_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">local</span>
</pre></div>
</div>
</div>
<div class="section" id="filestorage">
<h3>6.1.2. filestorage<a class="headerlink" href="#filestorage" title="Permalink to this headline">¶</a></h3>
<p>This is intended only for testing.  Values are stored in a local file
using the <a class="reference external" href="http://docs.python.org/library/shelve.html#module-shelve" title="(in Python v2.7)"><code class="xref py py-mod docutils literal"><span class="pre">shelve</span></code></a> module.  This does not require
<code class="docutils literal"><span class="pre">storage_addresses</span></code>, but it does require:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">kvlayer</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">storage_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">filestorage</span>

  <span class="c1"># Name of the file to use for storage</span>
  <span class="l-Scalar-Plain">filename</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/tmp/kvlayer.bin</span>

  <span class="c1"># If set, actually work on a copy of &quot;filename&quot; at this location.</span>
  <span class="l-Scalar-Plain">copy_to_filename</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/tmp/kvlayer-copy.bin</span>
</pre></div>
</div>
</div>
<div class="section" id="redis">
<h3>6.1.3. redis<a class="headerlink" href="#redis" title="Permalink to this headline">¶</a></h3>
<p>Uses the <a class="reference internal" href="#redis">Redis</a> in-memory database.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">kvlayer</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">storage_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">redis</span>

  <span class="c1"># host:port locations of Redis servers; only the first is used</span>
  <span class="l-Scalar-Plain">storage_addresses</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">redis.example.com</span><span class="p-Indicator">:</span><span class="nv">6379</span><span class="p-Indicator">]</span>

  <span class="c1"># Redis database number (default: 0)</span>
  <span class="l-Scalar-Plain">redis_db_num</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</pre></div>
</div>
</div>
<div class="section" id="accumulo">
<h3>6.1.4. accumulo<a class="headerlink" href="#accumulo" title="Permalink to this headline">¶</a></h3>
<p>Uses the Apache <a class="reference external" href="http://accumulo.apache.org/">Accumulo</a> distributed database.  Your installation
must be running the Accumulo proxy, and the configuration points at
that proxy.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">kvlayer</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">storage_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">accumulo</span>

  <span class="c1"># host:port location of the proxy; only the first is used</span>
  <span class="l-Scalar-Plain">storage_addresses</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">accumulo.example.com</span><span class="p-Indicator">:</span><span class="nv">50096</span><span class="p-Indicator">]</span>
  <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">root</span>
  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">secret</span>

  <span class="c1"># all of the following parameters are default values and are optional</span>
  <span class="l-Scalar-Plain">accumulo_max_memory</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1000000</span>
  <span class="l-Scalar-Plain">accumulo_timeout_ms</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">30000</span>
  <span class="l-Scalar-Plain">accumulo_threads</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>
  <span class="l-Scalar-Plain">accumulo_latency_ms</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>
  <span class="l-Scalar-Plain">thrift_framed_transport_size_in_mb</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">15</span>
</pre></div>
</div>
<p>Each kvlayer table is instantiated as an Accumulo table named
<code class="docutils literal"><span class="pre">appname_namespace_table</span></code>.</p>
</div>
<div class="section" id="postgrest">
<h3>6.1.5. postgrest<a class="headerlink" href="#postgrest" title="Permalink to this headline">¶</a></h3>
<p>Uses <a class="reference external" href="http://www.postgresql.org">PostgreSQL</a> for storage.  This backend is only available if the
<code class="xref py py-mod docutils literal"><span class="pre">psycopg2</span></code> module is installed.  The <code class="docutils literal"><span class="pre">storage_addresses</span></code> may be
a single <a class="reference external" href="http://www.postgresql.org/docs/current/static/libpq-connect.html#LIBPQ-PARAMKEYWORDS">PostgreSQL connection string</a>, or may be a <code class="docutils literal"><span class="pre">host:port</span></code>
format with additional configuration.  The <code class="docutils literal"><span class="pre">app_name</span></code> and
<code class="docutils literal"><span class="pre">namespace</span></code> can only consist of alphanumeric characters,
underscores, or <code class="docutils literal"><span class="pre">$</span></code>, and must begin with a letter or underscore.</p>
<p>This backend is newer than, less proven than, and incompatible with the
<code class="docutils literal"><span class="pre">postgres</span></code> backend described below.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">kvlayer</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">storage_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgrest</span>
  <span class="l-Scalar-Plain">storage_addresses</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&#39;postgres.example.com:5432&#39;</span><span class="p-Indicator">]</span>
  <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">test</span>
  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">test</span>
  <span class="l-Scalar-Plain">dbname</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">test</span>
  <span class="c1"># Equivalently, pack this all into a single SQL connection string</span>
  <span class="c1"># storage_addresses:</span>
  <span class="c1"># - &#39;host=postgres.example.com port=5432 user=test dbname=test password=test&#39;</span>

  <span class="c1"># all of the following parameters are default values and are optional</span>
  <span class="c1"># keep this many connections alive</span>
  <span class="l-Scalar-Plain">min_connections</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
  <span class="c1"># never create more than this many connections</span>
  <span class="l-Scalar-Plain">max_connections</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">16</span>
</pre></div>
</div>
<p>The backend assumes the user is able to run SQL <code class="docutils literal"><span class="pre">CREATE</span> <span class="pre">TABLE</span></code> and
<code class="docutils literal"><span class="pre">DROP</span> <span class="pre">TABLE</span></code> statements.  Each kvlayer table is instantiated as an
SQL table named <code class="docutils literal"><span class="pre">appname_namespace_table</span></code>.</p>
<p>Within the system, the <code class="docutils literal"><span class="pre">min_connections</span></code> and <code class="docutils literal"><span class="pre">max_connections</span></code>
property apply per client object.  If <code class="docutils literal"><span class="pre">min_connections</span></code> is set to 0
then the connection pool will never hold a connection alive, which
typically adds a performance cost to reconnect.</p>
</div>
<div class="section" id="postgres">
<h3>6.1.6. postgres<a class="headerlink" href="#postgres" title="Permalink to this headline">¶</a></h3>
<p>Uses <a class="reference external" href="http://www.postgresql.org">PostgreSQL</a> for storage.  This backend is only available if the
<code class="xref py py-mod docutils literal"><span class="pre">psycopg2</span></code> module is installed.  The <code class="docutils literal"><span class="pre">storage_type</span></code> is a
<a class="reference external" href="http://www.postgresql.org/docs/current/static/libpq-connect.html#LIBPQ-PARAMKEYWORDS">PostgreSQL connection string</a>.  The <code class="docutils literal"><span class="pre">app_name</span></code> and <code class="docutils literal"><span class="pre">namespace</span></code>
can only consist of alphanumeric characters, underscores, or <code class="docutils literal"><span class="pre">$</span></code>,
and must begin with a letter or underscore.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">kvlayer</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">storage_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgres</span>
  <span class="l-Scalar-Plain">storage_addresses</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="s">&#39;host=postgres.example.com</span><span class="nv"> </span><span class="s">port=5432</span><span class="nv"> </span><span class="s">user=test</span><span class="nv"> </span><span class="s">dbname=test</span><span class="nv"> </span><span class="s">password=test&#39;</span>

  <span class="c1"># all of the following parameters are default values and are optional</span>
  <span class="c1"># keep this many connections alive</span>
  <span class="l-Scalar-Plain">min_connections</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
  <span class="c1"># never create more than this many connections</span>
  <span class="l-Scalar-Plain">max_connections</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">16</span>
  <span class="c1"># break large scans (using SQL) into chunks of this many</span>
  <span class="l-Scalar-Plain">scan_inner_limit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1000</span>
</pre></div>
</div>
<p>The backend assumes the user is able to run SQL <code class="docutils literal"><span class="pre">CREATE</span> <span class="pre">TABLE</span></code> and
<code class="docutils literal"><span class="pre">DROP</span> <span class="pre">TABLE</span></code> statements.  Each kvlayer namespace is instantiated as
an SQL table named <code class="docutils literal"><span class="pre">kv_appname_namespace</span></code>; kvlayer tables are
collections of rows within the namespace table sharing a common field.</p>
<p>Within the system, the <code class="docutils literal"><span class="pre">min_connections</span></code> and <code class="docutils literal"><span class="pre">max_connections</span></code>
property apply per client object.  If <code class="docutils literal"><span class="pre">min_connections</span></code> is set to 0
then the connection pool will never hold a connection alive, which
typically adds a performance cost to reconnect.</p>
</div>
<div class="section" id="riak">
<h3>6.1.7. riak<a class="headerlink" href="#riak" title="Permalink to this headline">¶</a></h3>
<p>Uses <a class="reference internal" href="#riak">Riak</a> for storage.  This backend is only available if the
corresponding <code class="xref py py-mod docutils literal"><span class="pre">riak</span></code> client library is installed.  Multiple
<code class="docutils literal"><span class="pre">storage_addresses</span></code> are actively encouraged for this backend. Each
may be a simple string, or a dictionary containing keys <code class="docutils literal"><span class="pre">host</span></code>,
<code class="docutils literal"><span class="pre">http_port</span></code>, and <code class="docutils literal"><span class="pre">pb_port</span></code> if your setup is using non-standard
port numbers.  A typical setup will look like:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">kvlayer</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">storage_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">riak</span>
  <span class="l-Scalar-Plain">storage_addresses</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">riak01</span><span class="p-Indicator">,</span> <span class="nv">riak02</span><span class="p-Indicator">,</span> <span class="nv">riak03</span><span class="p-Indicator">,</span> <span class="nv">riak04</span><span class="p-Indicator">,</span> <span class="nv">riak05</span><span class="p-Indicator">]</span>
  <span class="c1"># optional settings with their default values</span>
  <span class="l-Scalar-Plain">protocol</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pbc</span> <span class="c1"># or http or https</span>
  <span class="l-Scalar-Plain">scan_limit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">100</span>
</pre></div>
</div>
<p>The setup from the Riak &#8220;Five-Minute Install&#8221; runs five separate
Riak nodes all on localhost, resulting in configuration like</p>
<p>One <a class="reference internal" href="#module-kvlayer" title="kvlayer"><code class="xref py py-mod docutils literal"><span class="pre">kvlayer</span></code></a> namespace corresponds to one Riak bucket.</p>
<p>The <code class="docutils literal"><span class="pre">protocol</span></code> setting selects between defaulting to the HTTP or
protocol buffer APIs.  While Riak&#8217;s default is generally <code class="docutils literal"><span class="pre">http</span></code>,
the <code class="docutils literal"><span class="pre">pbc</span></code> API seems to work equally well and is much faster.  The
kvlayer backend&#8217;s default is <code class="docutils literal"><span class="pre">pbc</span></code>.</p>
<p>The <code class="docutils literal"><span class="pre">scan_limit</span></code> setting determines how many results will be
returned from each secondary index search.  A higher setting for this
results in fewer network round-trips to get search results, but also
results in higher latency to return each.  This affects both calls to
the kvlayer scan API as well as calls to delete kvlayer tables, which
are also Riak key scans.</p>
<p>Your Riak cluster must be configured with secondary indexing enabled,
and correspondingly, must be using the LevelDB backend.  The default
bucket settings, and in particular setting <code class="docutils literal"><span class="pre">allow_mult</span></code> to
<code class="docutils literal"><span class="pre">false</span></code>, are correct for <a class="reference internal" href="#module-kvlayer" title="kvlayer"><code class="xref py py-mod docutils literal"><span class="pre">kvlayer</span></code></a>.</p>
</div>
<div class="section" id="split-s3">
<h3>6.1.8. split_s3<a class="headerlink" href="#split-s3" title="Permalink to this headline">¶</a></h3>
<p>Hybrid backend that stores values for specific tables in <a class="reference external" href="https://aws.amazon.com/s3/">Amazon S3</a>,
and pointers to those values and all other tables in some other
<a class="reference internal" href="#module-kvlayer" title="kvlayer"><code class="xref py py-mod docutils literal"><span class="pre">kvlayer</span></code></a> backend.  This backend is only available if the
<code class="xref py py-mod docutils literal"><span class="pre">boto</span></code> AWS access library is installed.  Using this effectively
requires knowing the internal details of what table names the end
application will use.  A typical all-Amazon setup would store bulk
objects in S3, and store all other objects in an <a class="reference external" href="https://aws.amazon.com/rds/">Amazon RDS</a>
PostgreSQL instance.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">kvlayer</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">storage_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">split_s3</span>
  <span class="l-Scalar-Plain">app_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kvlayer</span>
  <span class="l-Scalar-Plain">namespace</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">namespace</span>
  <span class="l-Scalar-Plain">split_s3</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">tables</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">stream_items</span><span class="p-Indicator">]</span>
    <span class="l-Scalar-Plain">aws_access_key_id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Axxxxxxxxxxxxxxxxxxx</span>
    <span class="l-Scalar-Plain">aws_secret_access_key</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0</span>
    <span class="l-Scalar-Plain">bucket</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mybucket</span>
    <span class="l-Scalar-Plain">path_prefix</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">kvlayer_prefix</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
    <span class="l-Scalar-Plain">retries</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
    <span class="l-Scalar-Plain">retry_interval</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0.1</span>
    <span class="l-Scalar-Plain">kvlayer</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">storage_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgres</span>
      <span class="l-Scalar-Plain">storage_addresses</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="p-Indicator">&gt;-</span>
            <span class="no">host=stuff.rds.amazonaws.com port=5432 user=db</span>
            <span class="no">dbname=db password=db</span>
</pre></div>
</div>
<p>An AWS key must be passed to the backend.  Either an access key ID and
the secret key can be embedded directly in the configuration, as shown
here, or <code class="docutils literal"><span class="pre">aws_access_key_id_path</span></code> and <code class="docutils literal"><span class="pre">aws_secret_access_key_path</span></code>
can be names of local files containing those credentials.</p>
<p>Objects are stored in the named <code class="docutils literal"><span class="pre">bucket</span></code>, which must exist already.
Each object&#8217;s key is constructed by taking <code class="docutils literal"><span class="pre">path_prefix</span></code> (if any);
if <code class="docutils literal"><span class="pre">kvlayer_prefix</span></code> is true (default), appending
<code class="docutils literal"><span class="pre">app_name/namespace/</span></code>; <code class="docutils literal"><span class="pre">table_name/</span></code>; and a SHA-256 hash of the
serialized object key, with the first two bytes split off to form a
directory hierarchy.  If your table&#8217;s schema is <code class="docutils literal"><span class="pre">(str,)</span></code> and you
wrote keys <code class="docutils literal"><span class="pre">a</span></code>, <code class="docutils literal"><span class="pre">b</span></code>, and <code class="docutils literal"><span class="pre">c</span></code> with the above configuration to
table <code class="docutils literal"><span class="pre">table</span></code>, these would be written to <code class="docutils literal"><span class="pre">mybucket</span></code> in respective
S3 object paths</p>
<blockquote>
<div>kvlayer/namespace/table/ca/97/8112ca1bbdcafac231b39a23dc4da786eff8147c4e72b9807785afee48bb
kvlayer/namespace/table/3e/23/e8160039594a33894f6564e1b1348bbd7a0088d42c4acb73eeaed59c009d
kvlayer/namespace/table/2e/7d/2c03a9507ae265ecf5b5356885a53393a2029d241394997265a1a25aefc6</div></blockquote>
<p>The kvlayer keys are written through to the underlying backend, but no
data is written there.  Only tables listed in the <code class="docutils literal"><span class="pre">tables</span></code> parameter
have data stored in S3 (required setting); all other tables are
processed normally.
<a class="reference internal" href="#kvlayer._abstract_storage.AbstractStorage.scan_keys" title="kvlayer._abstract_storage.AbstractStorage.scan_keys"><code class="xref py py-meth docutils literal"><span class="pre">scan_keys()</span></code></a> does not
talk to S3 at all, it just relays the scan from the underlying
backend.  Bulk-delete operations such as
<a class="reference internal" href="#kvlayer._abstract_storage.AbstractStorage.clear_table" title="kvlayer._abstract_storage.AbstractStorage.clear_table"><code class="xref py py-meth docutils literal"><span class="pre">clear_table()</span></code></a> and
<a class="reference internal" href="#kvlayer._abstract_storage.AbstractStorage.delete_namespace" title="kvlayer._abstract_storage.AbstractStorage.delete_namespace"><code class="xref py py-meth docutils literal"><span class="pre">delete_namespace()</span></code></a>
need to do a scan of the underlying table to find the keys to delete.
Particularly if data is being read back immediately after being
written, it is possible that a read (get or scan) operation will fail
to find the just-written object; a failed read for an object expected
to exist will be retried <code class="docutils literal"><span class="pre">retries</span></code> times (default 5), waiting
<code class="docutils literal"><span class="pre">retry_interval</span></code> seconds (default 0.1) between each.</p>
<p>The underlying backend is separately configured with its own
<code class="docutils literal"><span class="pre">kvlayer</span></code> section inside the backend configuration.</p>
</div>
<div class="section" id="cassandra">
<h3>6.1.9. cassandra<a class="headerlink" href="#cassandra" title="Permalink to this headline">¶</a></h3>
<p>Uses the Apache <a class="reference external" href="http://cassandra.apache.org/">Cassandra</a> distributed database.  Note that this
backend requires keys to be limited to tuples of UUIDs.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">kvlayer</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">storage_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">cassandra</span>
  <span class="l-Scalar-Plain">storage_addresses</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&#39;cassandra.example.com:9160&#39;</span><span class="p-Indicator">]</span>
  <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">root</span>
  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">secret</span>

  <span class="l-Scalar-Plain">connection_pool_size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
  <span class="l-Scalar-Plain">max_consistency_delay</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">120</span>
  <span class="l-Scalar-Plain">replication_factor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
  <span class="l-Scalar-Plain">thrift_framed_transport_size_in_mb</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">15</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="api">
<h2>6.2. API<a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h2>
<p>Having set up the global configuration, it is enough to call
<a class="reference internal" href="#kvlayer.client" title="kvlayer.client"><code class="xref py py-func docutils literal"><span class="pre">kvlayer.client()</span></code></a> to get a storage client object.</p>
<p>The API works in terms of &#8220;tables&#8221;, though these are slightly
different from tradational database tables.  Each table has keys which
are tuples of a fixed length.</p>
<dl class="function">
<dt id="kvlayer.client">
<code class="descclassname">kvlayer.</code><code class="descname">client</code><span class="sig-paren">(</span><em>config=None</em>, <em>storage_type=None</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/kvlayer/_client.html#client"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#kvlayer.client" title="Permalink to this definition">¶</a></dt>
<dd><p>Create a kvlayer client object.</p>
<p>With no arguments, gets the global <a class="reference internal" href="#module-kvlayer" title="kvlayer"><code class="xref py py-mod docutils literal"><span class="pre">kvlayer</span></code></a> configuration
from <a class="reference internal" href="yakonfig.html#module-yakonfig" title="yakonfig"><code class="xref py py-mod docutils literal"><span class="pre">yakonfig</span></code></a> and uses that.  A <cite>config</cite> dictionary, if
provided, is used in place of the <a class="reference internal" href="yakonfig.html#module-yakonfig" title="yakonfig"><code class="xref py py-mod docutils literal"><span class="pre">yakonfig</span></code></a> configuration.
<cite>storage_type</cite> overrides the corresponding field in the
configuration, but it must be supplied in one place or the other.
Any additional parameters are passed to the corresponding
backend&#8217;s constructor.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">local_storage</span> <span class="o">=</span> <span class="n">kvlayer</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="p">{},</span> <span class="n">storage_type</span><span class="o">=</span><span class="s">&#39;local&#39;</span><span class="p">,</span>
<span class="gp">... </span>                               <span class="n">app_name</span><span class="o">=</span><span class="s">&#39;app&#39;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s">&#39;ns&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>If there is additional configuration under the value of
<cite>storage_type</cite>, that is overlaid over <cite>config</cite> and passed to the
storage implementation.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>config</strong> (<a class="reference external" href="http://docs.python.org/library/stdtypes.html#dict" title="(in Python v2.7)"><em>dict</em></a>) &#8211; <a class="reference internal" href="#module-kvlayer" title="kvlayer"><code class="xref py py-mod docutils literal"><span class="pre">kvlayer</span></code></a> configuration dictionary</li>
<li><strong>storage_type</strong> (<a class="reference external" href="http://docs.python.org/library/functions.html#str" title="(in Python v2.7)"><em>str</em></a>) &#8211; name of storage implementation</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Raises kvlayer._exceptions.ConfigurationError:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><p class="first last">if <cite>storage_type</cite>
is not provided or is invalid</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="class">
<dt id="kvlayer._abstract_storage.AbstractStorage">
<em class="property">class </em><code class="descclassname">kvlayer._abstract_storage.</code><code class="descname">AbstractStorage</code><span class="sig-paren">(</span><em>config</em>, <em>app_name=None</em>, <em>namespace=None</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/kvlayer/_abstract_storage.html#AbstractStorage"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#kvlayer._abstract_storage.AbstractStorage" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference external" href="http://docs.python.org/library/functions.html#object" title="(in Python v2.7)"><code class="xref py py-class docutils literal"><span class="pre">object</span></code></a></p>
<p>Base class for all low-level storage implementations.</p>
<p>All of the table-like structures we use are setup like this:</p>
<div class="highlight-python"><div class="highlight"><pre>namespace = dict(
    table_name = dict((UUID, UUID, ...): val)
    ...
)
</pre></div>
</div>
<p>where the number of UUIDs in the key is a configurable parameter
of each table, and the &#8220;val&#8221; is always binary and might be a
trivial value, like 1.</p>
<dl class="method">
<dt id="kvlayer._abstract_storage.AbstractStorage.check_put_key_value">
<code class="descname">check_put_key_value</code><span class="sig-paren">(</span><em>key</em>, <em>value</em>, <em>table_name</em>, <em>key_spec=None</em>, <em>value_type=None</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/kvlayer/_abstract_storage.html#AbstractStorage.check_put_key_value"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#kvlayer._abstract_storage.AbstractStorage.check_put_key_value" title="Permalink to this definition">¶</a></dt>
<dd><p>Check that a key/value pair are consistent with the schema.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>key</strong> (<a class="reference external" href="http://docs.python.org/library/functions.html#tuple" title="(in Python v2.7)"><em>tuple</em></a>) &#8211; key to put</li>
<li><strong>value</strong> &#8211; value to put (ignored)</li>
<li><strong>table_name</strong> (<a class="reference external" href="http://docs.python.org/library/functions.html#str" title="(in Python v2.7)"><em>str</em></a>) &#8211; kvlayer table name (for errors only)</li>
<li><strong>key_spec</strong> (<a class="reference external" href="http://docs.python.org/library/functions.html#tuple" title="(in Python v2.7)"><em>tuple</em></a>) &#8211; definition of the table key</li>
<li><strong>value_type</strong> &#8211; type of the table value</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Raises kvlayer._exceptions.BadKey:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><p class="first last">if <cite>key</cite> doesn&#8217;t match <cite>key_spec</cite></p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="kvlayer._abstract_storage.AbstractStorage.value_to_str">
<code class="descname">value_to_str</code><span class="sig-paren">(</span><em>value</em>, <em>value_type</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/kvlayer/_abstract_storage.html#AbstractStorage.value_to_str"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#kvlayer._abstract_storage.AbstractStorage.value_to_str" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="kvlayer._abstract_storage.AbstractStorage.str_to_value">
<code class="descname">str_to_value</code><span class="sig-paren">(</span><em>value</em>, <em>value_type</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/kvlayer/_abstract_storage.html#AbstractStorage.str_to_value"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#kvlayer._abstract_storage.AbstractStorage.str_to_value" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="kvlayer._abstract_storage.AbstractStorage.setup_namespace">
<code class="descname">setup_namespace</code><span class="sig-paren">(</span><em>table_names</em>, <em>value_types=None</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/kvlayer/_abstract_storage.html#AbstractStorage.setup_namespace"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#kvlayer._abstract_storage.AbstractStorage.setup_namespace" title="Permalink to this definition">¶</a></dt>
<dd><p>Create tables in the namespace.</p>
<p>Can be run multiple times with different <cite>table_names</cite> in
order to expand the set of tables in the namespace.  This
generally needs to be called by every client, even if only
reading data.</p>
<p>Tables are specified by the form of their keys. A key must be
a tuple of a set number and type of parts. Currently types
<a class="reference external" href="http://docs.python.org/library/uuid.html#uuid.UUID" title="(in Python v2.7)"><code class="xref py py-class docutils literal"><span class="pre">uuid.UUID</span></code></a>, <a class="reference external" href="http://docs.python.org/library/functions.html#int" title="(in Python v2.7)"><code class="xref py py-class docutils literal"><span class="pre">int</span></code></a>, <a class="reference external" href="http://docs.python.org/library/functions.html#long" title="(in Python v2.7)"><code class="xref py py-class docutils literal"><span class="pre">long</span></code></a>, and
<a class="reference external" href="http://docs.python.org/library/functions.html#str" title="(in Python v2.7)"><code class="xref py py-class docutils literal"><span class="pre">str</span></code></a> are well supported, anything else is serialzed by
<code class="xref py py-func docutils literal"><span class="pre">str()</span></code>. Historically, a kvlayer key had to be a tuple of some
number of UUIDs.  <cite>table_names</cite> is a dictionary mapping a
table name to a tuple of types.  The dictionary values may also
be integers, in which case the tuple is that many UUIDs.</p>
<p><cite>value_types</cite> specifies the type of the values for a given
table.  Tables default to having a value type of <a class="reference external" href="http://docs.python.org/library/functions.html#str" title="(in Python v2.7)"><code class="xref py py-class docutils literal"><span class="pre">str</span></code></a>.
<a class="reference external" href="http://docs.python.org/library/functions.html#int" title="(in Python v2.7)"><code class="xref py py-class docutils literal"><span class="pre">int</span></code></a> and <a class="reference external" href="http://docs.python.org/library/functions.html#float" title="(in Python v2.7)"><code class="xref py py-class docutils literal"><span class="pre">float</span></code></a> are also permitted.  Value
types may also be <code class="xref py py-class docutils literal"><span class="pre">COUNTER</span></code> or <code class="xref py py-class docutils literal"><span class="pre">ACCUMULATOR</span></code>;
see <code class="xref py py-meth docutils literal"><span class="pre">increment()</span></code> for details on these types.  You must pass
the corresponding type as the value parameter to <code class="xref py py-meth docutils literal"><span class="pre">put()</span></code>,
and that type will be returned as the value part of
<code class="xref py py-meth docutils literal"><span class="pre">get()</span></code> and <code class="xref py py-meth docutils literal"><span class="pre">scan()</span></code>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>table_names</strong> (<a class="reference external" href="http://docs.python.org/library/stdtypes.html#dict" title="(in Python v2.7)"><em>dict</em></a>) &#8211; Mapping from table name to key type tuple</li>
<li><strong>value_types</strong> (<a class="reference external" href="http://docs.python.org/library/stdtypes.html#dict" title="(in Python v2.7)"><em>dict</em></a>) &#8211; Mapping from table name to value type</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="kvlayer._abstract_storage.AbstractStorage.delete_namespace">
<code class="descname">delete_namespace</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/kvlayer/_abstract_storage.html#AbstractStorage.delete_namespace"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#kvlayer._abstract_storage.AbstractStorage.delete_namespace" title="Permalink to this definition">¶</a></dt>
<dd><p>Deletes all data from namespace.</p>
</dd></dl>

<dl class="method">
<dt id="kvlayer._abstract_storage.AbstractStorage.clear_table">
<code class="descname">clear_table</code><span class="sig-paren">(</span><em>table_name</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/kvlayer/_abstract_storage.html#AbstractStorage.clear_table"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#kvlayer._abstract_storage.AbstractStorage.clear_table" title="Permalink to this definition">¶</a></dt>
<dd><p>Delete all data from one table.</p>
</dd></dl>

<dl class="method">
<dt id="kvlayer._abstract_storage.AbstractStorage.put">
<code class="descname">put</code><span class="sig-paren">(</span><em>table_name</em>, <em>*keys_and_values</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/kvlayer/_abstract_storage.html#AbstractStorage.put"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#kvlayer._abstract_storage.AbstractStorage.put" title="Permalink to this definition">¶</a></dt>
<dd><p>Save values for keys in <cite>table_name</cite>.</p>
<p>Each key must be a tuple of length and types as specified for
<cite>table_name</cite> in <code class="xref py py-meth docutils literal"><span class="pre">setup_namespace()</span></code>.</p>
</dd></dl>

<dl class="method">
<dt id="kvlayer._abstract_storage.AbstractStorage.log_put">
<code class="descname">log_put</code><span class="sig-paren">(</span><em>table_name</em>, <em>start_time</em>, <em>end_time</em>, <em>num_keys</em>, <em>keys_size</em>, <em>num_values</em>, <em>values_size</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/kvlayer/_abstract_storage.html#AbstractStorage.log_put"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#kvlayer._abstract_storage.AbstractStorage.log_put" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="kvlayer._abstract_storage.AbstractStorage.scan">
<code class="descname">scan</code><span class="sig-paren">(</span><em>table_name</em>, <em>*key_ranges</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/kvlayer/_abstract_storage.html#AbstractStorage.scan"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#kvlayer._abstract_storage.AbstractStorage.scan" title="Permalink to this definition">¶</a></dt>
<dd><p>Yield tuples of (key, value) from querying table_name for
items with keys within the specified ranges.  If no key_ranges
are provided, then yield all (key, value) pairs in table.
This may return nothing if the table is empty or there are
no matching keys in any of the specified ranges.</p>
<p>Each of the <cite>key_ranges</cite> is a pair of a start and end tuple to
scan.  To specify the beginning or end, a -Inf or Inf value,
use an empty tuple as the beginning or ending key of a range.</p>
</dd></dl>

<dl class="method">
<dt id="kvlayer._abstract_storage.AbstractStorage.log_scan">
<code class="descname">log_scan</code><span class="sig-paren">(</span><em>table_name</em>, <em>start_time</em>, <em>end_time</em>, <em>num_keys</em>, <em>keys_size</em>, <em>num_values</em>, <em>values_size</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/kvlayer/_abstract_storage.html#AbstractStorage.log_scan"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#kvlayer._abstract_storage.AbstractStorage.log_scan" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="kvlayer._abstract_storage.AbstractStorage.scan_keys">
<code class="descname">scan_keys</code><span class="sig-paren">(</span><em>table_name</em>, <em>*key_ranges</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/kvlayer/_abstract_storage.html#AbstractStorage.scan_keys"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#kvlayer._abstract_storage.AbstractStorage.scan_keys" title="Permalink to this definition">¶</a></dt>
<dd><p>Scan only the keys from a table.</p>
<p>Yields key tuples from queying <cite>table_name</cite> for keys within
the specified ranges.  If no <cite>key_ranges</cite> are provided, then
yield all key tuples in the table.  This may yield nothing if
the table is empty or there are no matching keys in any of the
specified ranges.</p>
<p>Each of the <cite>key_ranges</cite> is a pair of a start and end tuple to
scan.  To specify the beginning or end, a -Inf or Inf value,
use an empty tuple as the beginning or ending key of a range.</p>
</dd></dl>

<dl class="method">
<dt id="kvlayer._abstract_storage.AbstractStorage.log_scan_keys">
<code class="descname">log_scan_keys</code><span class="sig-paren">(</span><em>table_name</em>, <em>start_time</em>, <em>end_time</em>, <em>num_keys</em>, <em>keys_size</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/kvlayer/_abstract_storage.html#AbstractStorage.log_scan_keys"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#kvlayer._abstract_storage.AbstractStorage.log_scan_keys" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="kvlayer._abstract_storage.AbstractStorage.get">
<code class="descname">get</code><span class="sig-paren">(</span><em>table_name</em>, <em>*keys</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/kvlayer/_abstract_storage.html#AbstractStorage.get"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#kvlayer._abstract_storage.AbstractStorage.get" title="Permalink to this definition">¶</a></dt>
<dd><p>Yield tuples of (key, value) from querying table_name for items
with keys.  If any of the key tuples are not in the table,
those key tuples will be yielded with value <code class="xref py py-const docutils literal"><span class="pre">None</span></code>.</p>
</dd></dl>

<dl class="method">
<dt id="kvlayer._abstract_storage.AbstractStorage.log_get">
<code class="descname">log_get</code><span class="sig-paren">(</span><em>table_name</em>, <em>start_time</em>, <em>end_time</em>, <em>num_keys</em>, <em>keys_size</em>, <em>num_values</em>, <em>values_size</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/kvlayer/_abstract_storage.html#AbstractStorage.log_get"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#kvlayer._abstract_storage.AbstractStorage.log_get" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="kvlayer._abstract_storage.AbstractStorage.delete">
<code class="descname">delete</code><span class="sig-paren">(</span><em>table_name</em>, <em>*keys</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/kvlayer/_abstract_storage.html#AbstractStorage.delete"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#kvlayer._abstract_storage.AbstractStorage.delete" title="Permalink to this definition">¶</a></dt>
<dd><p>Delete all (key, value) pairs with specififed keys</p>
</dd></dl>

<dl class="method">
<dt id="kvlayer._abstract_storage.AbstractStorage.log_delete">
<code class="descname">log_delete</code><span class="sig-paren">(</span><em>table_name</em>, <em>start_time</em>, <em>end_time</em>, <em>num_keys</em>, <em>keys_size</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/kvlayer/_abstract_storage.html#AbstractStorage.log_delete"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#kvlayer._abstract_storage.AbstractStorage.log_delete" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="kvlayer._abstract_storage.AbstractStorage.close">
<code class="descname">close</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/kvlayer/_abstract_storage.html#AbstractStorage.close"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#kvlayer._abstract_storage.AbstractStorage.close" title="Permalink to this definition">¶</a></dt>
<dd><p>close connections and end use of this storage client</p>
</dd></dl>

<dl class="method">
<dt id="kvlayer._abstract_storage.AbstractStorage.increment">
<code class="descname">increment</code><span class="sig-paren">(</span><em>table_name</em>, <em>*keys_and_values</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/kvlayer/_abstract_storage.html#AbstractStorage.increment"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#kvlayer._abstract_storage.AbstractStorage.increment" title="Permalink to this definition">¶</a></dt>
<dd><p>Add values to a counter-type table.</p>
<p><cite>keys_and_values</cite> are parameters of <cite>(key, value)</cite> pairs.  The
values must be <a class="reference external" href="http://docs.python.org/library/functions.html#int" title="(in Python v2.7)"><code class="xref py py-class docutils literal"><span class="pre">int</span></code></a>, if <cite>table_name</cite> is a
<code class="xref py py-class docutils literal"><span class="pre">COUNTER</span></code> table, or <a class="reference external" href="http://docs.python.org/library/functions.html#float" title="(in Python v2.7)"><code class="xref py py-class docutils literal"><span class="pre">float</span></code></a>, if <cite>table_name</cite> is
a <code class="xref py py-class docutils literal"><span class="pre">ACCUMULATOR</span></code> table.  For each key, the current value
is fetched from the storage, the value is added to it, and the
resulting value added back into the storage.</p>
<p>This method is not guaranteed to be atomic, either on a
specific key or across all keys, but specific backends may
have better guarantees.  The behavior is unspecified if the
same key is included multiple times in the parameter list.</p>
<p>To use this, you must have passed <cite>table_name</cite> to
<code class="xref py py-meth docutils literal"><span class="pre">setup_namespaces()</span></code> in its <cite>value_types</cite> parameter,
setting the value type to <code class="xref py py-data docutils literal"><span class="pre">COUNTER</span></code> or
<code class="xref py py-data docutils literal"><span class="pre">ACCUMULATOR</span></code>.  When you do this, you pass and receive
<a class="reference external" href="http://docs.python.org/library/functions.html#float" title="(in Python v2.7)"><code class="xref py py-class docutils literal"><span class="pre">float</span></code></a> values back from all methods in this class for
that table.  <code class="xref py py-meth docutils literal"><span class="pre">put()</span></code> directly sets the values of counter
keys.  Counter values default to 0; if you change a counter
value to 0 then it will be &#8220;present&#8221; for purposes of
<code class="xref py py-meth docutils literal"><span class="pre">get()</span></code>, <code class="xref py py-meth docutils literal"><span class="pre">scan()</span></code>, and <code class="xref py py-meth docutils literal"><span class="pre">scan_keys()</span></code>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>table_name</strong> (<a class="reference external" href="http://docs.python.org/library/functions.html#str" title="(in Python v2.7)"><em>str</em></a>) &#8211; name of table to update</li>
<li><strong>keys_and_values</strong> &#8211; additional parameters are pairs of
key tuple and numeric delta value</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="kvlayer.DatabaseEmpty">
<em class="property">class </em><code class="descclassname">kvlayer.</code><code class="descname">DatabaseEmpty</code><a class="reference internal" href="../_modules/kvlayer/_exceptions.html#DatabaseEmpty"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#kvlayer.DatabaseEmpty" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="class">
<dt id="kvlayer.BadKey">
<em class="property">class </em><code class="descclassname">kvlayer.</code><code class="descname">BadKey</code><a class="reference internal" href="../_modules/kvlayer/_exceptions.html#BadKey"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#kvlayer.BadKey" title="Permalink to this definition">¶</a></dt>
<dd><p>A key value passed to a kvlayer function was not of the correct form.</p>
<p>Keys must be tuples of a fixed length and with specific types.
The length of the tuple is specified in the initial call to
<a class="reference internal" href="#kvlayer._abstract_storage.AbstractStorage.setup_namespace" title="kvlayer._abstract_storage.AbstractStorage.setup_namespace"><code class="xref py py-meth docutils literal"><span class="pre">kvlayer._abstract_storage.AbstractStorage.setup_namespace()</span></code></a>.</p>
</dd></dl>

</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">6. <code class="docutils literal"><span class="pre">kvlayer</span></code> &#8212; database abstraction for key/value stores</a><ul>
<li><a class="reference internal" href="#backends">6.1. Backends</a><ul>
<li><a class="reference internal" href="#local">6.1.1. local</a></li>
<li><a class="reference internal" href="#filestorage">6.1.2. filestorage</a></li>
<li><a class="reference internal" href="#redis">6.1.3. redis</a></li>
<li><a class="reference internal" href="#accumulo">6.1.4. accumulo</a></li>
<li><a class="reference internal" href="#postgrest">6.1.5. postgrest</a></li>
<li><a class="reference internal" href="#postgres">6.1.6. postgres</a></li>
<li><a class="reference internal" href="#riak">6.1.7. riak</a></li>
<li><a class="reference internal" href="#split-s3">6.1.8. split_s3</a></li>
<li><a class="reference internal" href="#cassandra">6.1.9. cassandra</a></li>
</ul>
</li>
<li><a class="reference internal" href="#api">6.2. API</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="dblogger.html"
                        title="previous chapter">5. <code class="docutils literal"><span class="pre">dblogger</span></code> &#8212; Python logging setup and database backend</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="rejester.html"
                        title="next chapter">7. <code class="docutils literal"><span class="pre">rejester</span></code> &#8212; Redis-based distributed work manager</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/sphinx-docs/kvlayer.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="rejester.html" title="7. rejester — Redis-based distributed work manager"
             >next</a> |</li>
        <li class="right" >
          <a href="dblogger.html" title="5. dblogger — Python logging setup and database backend"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">streamcorpus-pipeline 0.7.10.dev1 documentation</a> &raquo;</li> 
      </ul>
    </div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-50390027-1', 'streamcorpus.org');
  ga('send', 'pageview');

</script>

  </body>
</html>