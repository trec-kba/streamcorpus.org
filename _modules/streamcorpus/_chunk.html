<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>streamcorpus._chunk &mdash; streamcorpus-pipeline 0.7.10.dev1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.7.10.dev1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="streamcorpus-pipeline 0.7.10.dev1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">streamcorpus-pipeline 0.7.10.dev1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for streamcorpus._chunk</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Provides a reader/writer for batches of Thrift messages stored in flat</span>
<span class="sd">files.</span>

<span class="sd">Defaults to streamcorpus.StreamItem and can be used with any</span>
<span class="sd">Thrift-defined objects.</span>

<span class="sd">This software is released under an MIT/X11 open source license.</span>

<span class="sd">Copyright 2012-2015 Diffeo, Inc.</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">exceptions</span>
<span class="kn">import</span> <span class="nn">gzip</span> <span class="kn">as</span> <span class="nn">gz</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">cPickle</span> <span class="kn">as</span> <span class="nn">pickle</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pickle</span>

<span class="c"># import the thrift library</span>
<span class="kn">from</span> <span class="nn">thrift</span> <span class="kn">import</span> <span class="n">Thrift</span>
<span class="kn">from</span> <span class="nn">thrift.transport</span> <span class="kn">import</span> <span class="n">TTransport</span>
<span class="kn">from</span> <span class="nn">thrift.protocol.TBinaryProtocol</span> <span class="kn">import</span> <span class="n">TBinaryProtocol</span><span class="p">,</span> <span class="n">TBinaryProtocolAccelerated</span>
<span class="n">fastbinary_import_failure</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">thrift.protocol</span> <span class="kn">import</span> <span class="n">fastbinary</span>
    <span class="c">## use faster C program to read/write</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">TBinaryProtocolAccelerated</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span>
    <span class="n">fastbinary_import_failure</span> <span class="o">=</span> <span class="n">exc</span>
    <span class="c">## fall back to pure python</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">TBinaryProtocol</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">backports</span> <span class="kn">import</span> <span class="n">lzma</span> <span class="k">as</span> <span class="n">xz</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">xz</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">snappy</span> <span class="kn">as</span> <span class="nn">sz</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">sz</span> <span class="o">=</span> <span class="bp">None</span>

<span class="kn">from</span> <span class="nn">.ttypes</span> <span class="kn">import</span> <span class="n">StreamItem</span> <span class="k">as</span> <span class="n">StreamItem_v0_3_0</span>
<span class="kn">from</span> <span class="nn">.ttypes_v0_1_0</span> <span class="kn">import</span> <span class="n">StreamItem</span> <span class="k">as</span> <span class="n">StreamItem_v0_1_0</span>
<span class="kn">from</span> <span class="nn">.ttypes_v0_2_0</span> <span class="kn">import</span> <span class="n">StreamItem</span> <span class="k">as</span> <span class="n">StreamItem_v0_2_0</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;streamcorpus&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="VersionMismatchError"><a class="viewcode-back" href="../../sphinx-docs/streamcorpus.html#streamcorpus.VersionMismatchError">[docs]</a><span class="k">class</span> <span class="nc">VersionMismatchError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;The version of a stream item is not what was expected.&#39;&#39;&#39;</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="serialize"><a class="viewcode-back" href="../../sphinx-docs/streamcorpus.html#streamcorpus.serialize">[docs]</a><span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generate a serialized binary blob for a single message</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">o_transport</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="n">o_protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">(</span><span class="n">o_transport</span><span class="p">)</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">o_protocol</span><span class="p">)</span>
    <span class="n">o_transport</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">o_transport</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="deserialize"><a class="viewcode-back" href="../../sphinx-docs/streamcorpus.html#streamcorpus.deserialize">[docs]</a><span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">StreamItem_v0_3_0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generate a msg from a serialized binary blob for a single msg</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">chunk</span> <span class="o">=</span> <span class="n">Chunk</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">blob</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
    <span class="n">mesgs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesgs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;got </span><span class="si">%d</span><span class="s"> messages to deserialize instead of one: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">mesgs</span><span class="p">),</span> <span class="n">mesgs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mesgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</div>
<span class="k">class</span> <span class="nc">md5_file</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Adapter around a filehandle that wraps .read and .write so that it</span>
<span class="sd">    can construct an md5_hexdigest property</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="o">=</span> <span class="n">fh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s">&#39;get_value&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">get_value</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s">&#39;seek&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seek</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">seek</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s">&#39;mode&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">mode</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s">&#39;flush&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">flush</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s">&#39;close&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">close</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_md5</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_md5</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_md5</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_md5</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">readAll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sz</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This method allows TBinaryProtocolAccelerated to actually function.</span>

<span class="sd">        Copied from here</span>
<span class="sd">        http://svn.apache.org/repos/asf/hive/trunk/service/lib/py/thrift/transport/TTransport.py</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">buff</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">have</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">have</span> <span class="o">&lt;</span> <span class="n">sz</span><span class="p">):</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">sz</span><span class="o">-</span><span class="n">have</span><span class="p">)</span>
            <span class="n">have</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="n">buff</span> <span class="o">+=</span> <span class="n">chunk</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">EOFError</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">buff</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">md5_hexdigest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_md5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">BaseChunk</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    reader/writer for batches of messages stored in flat files.</span>
<span class="sd">    This class handles compression, md5, and item counts.</span>

<span class="sd">    Serialization specifics handled by subclass (Thrift, pickle, etc.)</span>
<span class="sd">    Abstract base class. Needs write_msg_impl() read_msg_impl()</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">file_obj</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;rb&#39;</span><span class="p">,</span>
                 <span class="n">message</span><span class="o">=</span><span class="n">StreamItem_v0_3_0</span><span class="p">,</span>
                 <span class="n">read_wrapper</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">write_wrapper</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">inline_md5</span><span class="o">=</span><span class="bp">True</span>
        <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Load a chunk from an existing file handle or buffer of data.</span>
<span class="sd">        If no data is passed in, then chunk starts as empty and</span>
<span class="sd">        chunk.add(message) can be called to append to it.</span>

<span class="sd">        mode is only used if you specify a path to an existing file to</span>
<span class="sd">        open.</span>

<span class="sd">        :param path: path to a file in the local file system.  If path</span>
<span class="sd">        ends in .xz then mode must be &#39;rb&#39; and the entire file is</span>
<span class="sd">        loaded into memory and decompressed before the Chunk is ready</span>
<span class="sd">        for reading.</span>

<span class="sd">        :param mode: read/write mode for opening the file; if</span>
<span class="sd">        mode=&#39;wb&#39;, then a file will be created.</span>

<span class="sd">        :file_obj: already opened file, mode must agree with mode</span>
<span class="sd">        parameter.</span>

<span class="sd">        :param data: bytes of data from which to read messages</span>

<span class="sd">        :param message: defaults to StreamItem_v0_3_0; you can specify</span>
<span class="sd">        your own Thrift-generated class here.</span>

<span class="sd">        :param read_wrapper: a function that takes a deserialized</span>
<span class="sd">        message as input and returns a new object to yield from</span>
<span class="sd">        __iter__</span>

<span class="sd">        :param write_wrapper: a function used in Chunk.add(obj) that</span>
<span class="sd">        takes the added object as input and returns another object</span>
<span class="sd">        that is a thrift class that can be serialized.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_wrapper</span> <span class="o">=</span> <span class="n">read_wrapper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_wrapper</span> <span class="o">=</span> <span class="n">write_wrapper</span>

        <span class="n">allowed_modes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;wb&#39;</span><span class="p">,</span> <span class="s">&#39;ab&#39;</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">allowed_modes</span><span class="p">,</span> <span class="s">&#39;mode=</span><span class="si">%r</span><span class="s"> not in </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">allowed_modes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>

        <span class="c">## class for constructing messages when reading</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>

        <span class="c">## initialize internal state before figuring out what data we</span>
        <span class="c">## are acting on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_md5_hexdigest</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c">## might not have any output parts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_o_chunk_fh</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c">## might not have any input parts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_i_chunk_fh</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c">## open an existing file from path, or create it</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">file_obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> \
                <span class="s">&#39;Must specify only path or data or file_obj&#39;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="c">## if the file is there, then use mode</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;rb&#39;</span><span class="p">,</span> <span class="s">&#39;ab&#39;</span><span class="p">]:</span>
                    <span class="n">exc</span> <span class="o">=</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&#39;mode=</span><span class="si">%r</span><span class="s"> would overwrite existing </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
                    <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span>
                    <span class="k">raise</span> <span class="n">exc</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.xz&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">xz</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s">&#39;rb&#39;</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;backports.lzma is not installed and mode=</span><span class="si">%r</span><span class="s"> but only &quot;rb&quot; is allowed without backports.lzma&#39;</span> <span class="o">%</span> <span class="n">mode</span><span class="p">)</span>
                        <span class="c">## launch xz child</span>
                        <span class="n">xz_child</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
                            <span class="p">[</span><span class="s">&#39;xzcat&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">],</span>
                            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
                        <span class="n">file_obj</span> <span class="o">=</span> <span class="n">xz_child</span><span class="o">.</span><span class="n">stdout</span>
                        <span class="c">## what to do with stderr</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">file_obj</span> <span class="o">=</span> <span class="n">xz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.gz&#39;</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;rb&#39;</span><span class="p">,</span> <span class="s">&#39;mode=</span><span class="si">%r</span><span class="s"> for .gz&#39;</span> <span class="o">%</span> <span class="n">mode</span>
                    <span class="n">file_obj</span>  <span class="o">=</span> <span class="n">gz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.xz.gpg&#39;</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;rb&#39;</span><span class="p">,</span> <span class="s">&#39;mode=</span><span class="si">%r</span><span class="s"> for .xz&#39;</span> <span class="o">%</span> <span class="n">mode</span>
                    <span class="c">## launch xz child</span>
                    <span class="n">xz_child</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
                        <span class="p">[</span><span class="s">&#39;gpg -d </span><span class="si">%s</span><span class="s"> | xz --decompress&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">],</span>
                        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                        <span class="c">#stderr=subprocess.PIPE)</span>
                    <span class="n">file_obj</span> <span class="o">=</span> <span class="n">xz_child</span><span class="o">.</span><span class="n">stdout</span>
                    <span class="c">## what to do with stderr?</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">file_obj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c">## otherwise make one for writing</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;wb&#39;</span><span class="p">,</span> <span class="s">&#39;ab&#39;</span><span class="p">]:</span>
                    <span class="n">exc</span> <span class="o">=</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> does not exist but mode=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>
                    <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">=</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span>
                    <span class="k">raise</span> <span class="n">exc</span>
                <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dirname</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.gz&#39;</span><span class="p">):</span>
                    <span class="n">file_obj</span> <span class="o">=</span> <span class="n">gz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.xz&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">xz</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;file extension is .xz but backports.lzma is not installed&#39;</span><span class="p">)</span>
                    <span class="n">file_obj</span> <span class="o">=</span> <span class="n">xz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">file_obj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

        <span class="c">## if created without any arguments, then prepare to add</span>
        <span class="c">## messages to an in-memory file object</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">file_obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c">## make the default behavior when instantiated as Chunk()</span>
            <span class="c">## to write to an in-memory buffer</span>
            <span class="n">file_obj</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s">&#39;wb&#39;</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span>

        <span class="k">elif</span> <span class="n">file_obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="c">## --&gt; must have &#39;data&#39;</span>
            <span class="c">## wrap the data in a file obj for reading</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;rb&#39;</span><span class="p">:</span>
                <span class="n">file_obj</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">file_obj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;ab&#39;</span><span class="p">:</span>
                <span class="n">file_obj</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
                <span class="n">file_obj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="c">## and let it just keep writing to it</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;mode=</span><span class="si">%r</span><span class="s"> but specified &quot;data&quot;&#39;</span> <span class="o">%</span> <span class="n">mode</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">file_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">file_obj</span><span class="p">,</span> <span class="s">&#39;mode&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_obj</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="c">## some tools, like python gzip library, use int modes</span>
                <span class="n">file_obj_mode</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s">&#39;w&#39;</span><span class="p">}[</span><span class="n">file_obj</span><span class="o">.</span><span class="n">mode</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file_obj_mode</span> <span class="o">=</span> <span class="n">file_obj</span><span class="o">.</span><span class="n">mode</span>

            <span class="k">assert</span> <span class="n">file_obj_mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;file_obj.mode=</span><span class="si">%r</span><span class="s"> != </span><span class="si">%r</span><span class="s">=mode&#39;</span>\
                <span class="o">%</span> <span class="p">(</span><span class="n">file_obj_mode</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
            <span class="c">## use the file object for writing out the data as it</span>
            <span class="c">## happens, i.e. in streaming mode.</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;ab&#39;</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">inline_md5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_o_chunk_fh</span> <span class="o">=</span> <span class="n">md5_file</span><span class="p">(</span> <span class="n">file_obj</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_o_chunk_fh</span> <span class="o">=</span> <span class="n">file_obj</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;rb&#39;</span><span class="p">,</span> <span class="n">mode</span>
            <span class="k">if</span> <span class="n">inline_md5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_i_chunk_fh</span> <span class="o">=</span> <span class="n">md5_file</span><span class="p">(</span> <span class="n">file_obj</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_i_chunk_fh</span> <span class="o">=</span> <span class="n">file_obj</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="s">&#39;add message instance to chunk&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_wrapper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_wrapper</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write_msg_impl</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">write_msg_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_o_chunk_fh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_o_chunk_fh</span><span class="p">,</span> <span class="s">&#39;flush&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_o_chunk_fh</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Close any chunk file that we might have had open for writing.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_o_chunk_fh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_o_chunk_fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c">## make this method idempotent</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_o_chunk_fh</span><span class="p">,</span> <span class="n">md5_file</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_md5_hexdigest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_o_chunk_fh</span><span class="o">.</span><span class="n">md5_hexdigest</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_o_chunk_fh</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">md5_hexdigest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_md5_hexdigest</span><span class="p">:</span>
            <span class="c">## only set if closed already</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_md5_hexdigest</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_o_chunk_fh</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_o_chunk_fh</span><span class="p">,</span> <span class="s">&#39;md5_hexdigest&#39;</span><span class="p">):</span>
            <span class="c">## get it directly from the output chunk</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_o_chunk_fh</span><span class="o">.</span><span class="n">md5_hexdigest</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_chunk_fh</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_i_chunk_fh</span><span class="p">,</span> <span class="s">&#39;md5_hexdigest&#39;</span><span class="p">):</span>
            <span class="c">## get it directly from the input chunk</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_chunk_fh</span><span class="o">.</span><span class="n">md5_hexdigest</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">## maybe return raise?</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;{0}(len={1})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c">## how to make this pythonic given that we have __iter__?</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Iterator over messages in the chunk</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_msg_impl</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_wrapper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_wrapper</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="nf">read_msg_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        implementations should yield read objects of self.message type</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>


<div class="viewcode-block" id="Chunk"><a class="viewcode-back" href="../../sphinx-docs/streamcorpus.html#streamcorpus.Chunk">[docs]</a><span class="k">class</span> <span class="nc">Chunk</span><span class="p">(</span><span class="n">BaseChunk</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Chunk, the default Chunk, is a Thrift Chunk.</span>
<span class="sd">    See also PickleChunk, JsonChunk, and CborChunk&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Chunk</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fastbinary_import_failure</span><span class="p">:</span>
            <span class="c">#logger.debug(&#39;using TBinaryProtocolAccelerated (fastbinary)&#39;)</span>
            <span class="k">pass</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;import fastbinary failed; falling back to 15x slower TBinaryProtocol: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">fastbinary_import_failure</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_o_transport</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_o_protocol</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_otp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_o_protocol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_o_transport</span> <span class="o">=</span> <span class="n">TTransport</span><span class="o">.</span><span class="n">TBufferedTransport</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_o_chunk_fh</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_o_protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_o_transport</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_o_protocol</span>

<div class="viewcode-block" id="Chunk.write_msg_impl"><a class="viewcode-back" href="../../sphinx-docs/streamcorpus.html#streamcorpus.Chunk.write_msg_impl">[docs]</a>    <span class="k">def</span> <span class="nf">write_msg_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="s">&#39;add message instance to chunk&#39;</span>
        <span class="n">o_protocol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_otp</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">o_protocol</span><span class="p">,</span> <span class="s">&#39;cannot add to a Chunk instantiated with data&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_o_chunk_fh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;cannot Chunk.add after Chunk.close&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">VersionMismatchError</span><span class="p">(</span>
                <span class="s">&#39;mismatched type: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">))</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">o_protocol</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Chunk.flush"><a class="viewcode-back" href="../../sphinx-docs/streamcorpus.html#streamcorpus.Chunk.flush">[docs]</a>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_o_transport</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_o_transport</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Chunk</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Chunk.close"><a class="viewcode-back" href="../../sphinx-docs/streamcorpus.html#streamcorpus.Chunk.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_o_transport</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_o_transport</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_o_transport</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Chunk</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Chunk.read_msg_impl"><a class="viewcode-back" href="../../sphinx-docs/streamcorpus.html#streamcorpus.Chunk.read_msg_impl">[docs]</a>    <span class="k">def</span> <span class="nf">read_msg_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Iterator over messages in the chunk</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_chunk_fh</span><span class="p">,</span> <span class="s">&#39;cannot iterate over a Chunk open for writing&#39;</span>

        <span class="c">## attempt to seek to the start, so can iterate multiple times</span>
        <span class="c">## over the chunk</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_i_chunk_fh</span><span class="p">,</span> <span class="s">&#39;seek&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_i_chunk_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">pass</span>
                <span class="c">## just assume that it is a pipe like stdin that need</span>
                <span class="c">## not be seeked to start</span>

        <span class="c">## wrap the file handle in buffered transport</span>
        <span class="n">i_transport</span> <span class="o">=</span> <span class="n">TTransport</span><span class="o">.</span><span class="n">TBufferedTransport</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_i_chunk_fh</span><span class="p">)</span>
        <span class="c">## use the Thrift Binary Protocol</span>
        <span class="n">i_protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">(</span><span class="n">i_transport</span><span class="p">)</span>

        <span class="c">## read message instances until input buffer is exhausted</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>

            <span class="c">## instantiate a message  instance</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c">## read it from the thrift protocol instance</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">i_protocol</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">&#39;version&#39;</span><span class="p">):</span>
                    <span class="c">## compare the read version to the default version</span>
                    <span class="c">## value on the identified message</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">()</span><span class="o">.</span><span class="n">version</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">VersionMismatchError</span><span class="p">(</span>
                            <span class="s">&#39;read msg.version = </span><span class="si">%d</span><span class="s"> != </span><span class="si">%d</span><span class="s"> = message().version):&#39;</span> <span class="o">%</span> \
                                <span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">()</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
                <span class="k">yield</span> <span class="n">msg</span>

            <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
                <span class="k">break</span>

</div></div>
<span class="kn">import</span> <span class="nn">json</span>
<span class="k">class</span> <span class="nc">JsonChunk</span><span class="p">(</span><span class="n">BaseChunk</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    `message` must be a constructor or factory function that accepts the object from json.load() that results from json.dump(write_wrapper(msg))</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">JsonChunk</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_msg_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_o_chunk_fh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_o_chunk_fh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_o_chunk_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_msg_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_chunk_fh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_chunk_fh</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">ob</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">ob</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">msg</span>


<span class="k">class</span> <span class="nc">PickleChunk</span><span class="p">(</span><span class="n">BaseChunk</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PickleChunk</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_msg_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_o_chunk_fh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_o_chunk_fh</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_msg_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_chunk_fh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ob</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_i_chunk_fh</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">ob</span>
            <span class="k">except</span> <span class="ne">EOFError</span> <span class="k">as</span> <span class="n">eof</span><span class="p">:</span>
                <span class="c"># okay</span>
                <span class="k">return</span>

<div class="viewcode-block" id="decrypt_and_uncompress"><a class="viewcode-back" href="../../sphinx-docs/streamcorpus.html#streamcorpus.decrypt_and_uncompress">[docs]</a><span class="k">def</span> <span class="nf">decrypt_and_uncompress</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">gpg_private</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                           <span class="n">compression</span><span class="o">=</span><span class="s">&#39;xz&#39;</span><span class="p">,</span> <span class="n">detect_compression</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Given a data buffer of bytes, if gpg_key_path is provided, decrypt</span>
<span class="sd">    data using gnupg, and uncompress using `compression` scheme, which</span>
<span class="sd">    defaults to &quot;xz&quot; and can also be &quot;gz&quot;, &quot;sz&quot;, or &quot;&quot;.</span>

<span class="sd">    :returns: a tuple of (logs, data), where `logs` is an array of</span>
<span class="sd">      strings and data is a binary string</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;decrypt_and_uncompress starting with empty data&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="s">&#39;no data&#39;</span><span class="p">],</span> <span class="bp">None</span>
    <span class="n">_errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">gpg_private</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c">### setup gpg for decryption</span>
        <span class="n">gpg_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">tempnam</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s">&#39;tmp-compress-and-encrypt-&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">gpg_dir</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gpg_child</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
                <span class="p">[</span><span class="s">&#39;gpg&#39;</span><span class="p">,</span> <span class="s">&#39;--no-permission-warning&#39;</span><span class="p">,</span> <span class="s">&#39;--homedir&#39;</span><span class="p">,</span> <span class="n">gpg_dir</span><span class="p">,</span>
                 <span class="s">&#39;--import&#39;</span><span class="p">,</span> <span class="n">gpg_private</span><span class="p">],</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="n">s_out</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">gpg_child</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="n">_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;gpg logs to stderr, read carefully:</span><span class="se">\n\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                               <span class="n">errors</span><span class="p">)</span>

            <span class="c">## decrypt it, and free memory</span>
            <span class="c">## encrypt using the fingerprint for our trec-kba-rsa key pair</span>
            <span class="n">gpg_child</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
                <span class="c">## setup gpg to decrypt with trec-kba private key</span>
                <span class="c">## (i.e. make it the recipient), with zero compression,</span>
                <span class="c">## ascii armoring is off by default, and --output - must</span>
                <span class="c">## appear before --decrypt -</span>
                <span class="p">[</span><span class="s">&#39;gpg&#39;</span><span class="p">,</span>   <span class="s">&#39;--no-permission-warning&#39;</span><span class="p">,</span> <span class="s">&#39;--homedir&#39;</span><span class="p">,</span> <span class="n">gpg_dir</span><span class="p">,</span>
                 <span class="s">&#39;--trust-model&#39;</span><span class="p">,</span> <span class="s">&#39;always&#39;</span><span class="p">,</span> <span class="s">&#39;--output&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;--decrypt&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">],</span>
                <span class="n">stdin</span> <span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="c">## communicate with child via its stdin</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">gpg_child</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="n">_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c">## remove the gpg_dir</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">gpg_dir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;empty data after gpg decrypt&#39;</span><span class="p">)</span>
            <span class="n">_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;gpg -&gt; no data&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_errors</span><span class="p">,</span> <span class="bp">None</span>

    <span class="c"># First check if the data matches any magic strings</span>
    <span class="n">did_decompress</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">detect_compression</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;7zXZ&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">xz_decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">did_decompress</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;sNaPpY&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">snappy_decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">did_decompress</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\x1f\x8b\x08</span><span class="s">&#39;</span><span class="p">:</span>  <span class="c"># gzip+deflate section header bytes</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">gzip_decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">did_decompress</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c"># else fall through and use a named decompression or raw data</span>
    <span class="c"># Next do decompression based on compression config</span>
    <span class="k">if</span> <span class="n">did_decompress</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">compression</span> <span class="o">==</span> <span class="s">&#39;xz&#39;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">xz_decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">compression</span> <span class="o">==</span> <span class="s">&#39;sz&#39;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">snappy_decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">compression</span> <span class="o">==</span> <span class="s">&#39;gz&#39;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">gzip_decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">compression</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="ow">or</span> <span class="n">compression</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c">## data is not compressed</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">_errors</span><span class="p">,</span> <span class="n">data</span>

</div>
<span class="k">def</span> <span class="nf">snappy_decompress</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sz</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Snappy decompression is not available&#39;</span><span class="p">)</span>
    <span class="c">## sz.decompress is broken per https://github.com/andrix/python-snappy/issues/28</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="n">sz</span><span class="o">.</span><span class="n">stream_decompress</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">fh</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fh</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">gzip_decompress</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">gz_fh</span> <span class="o">=</span> <span class="n">gz</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">fh</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">gz_fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">xz_decompress</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;decompress xz `data` using backports.lzma, or if that&#39;s not</span>
<span class="sd">    available then the commandline `xz --decompress` tool</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">xz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bigdata</span> <span class="o">=</span> <span class="n">xz</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">bigdata</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;decompress of </span><span class="si">%s</span><span class="s"> bytes failed&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="k">raise</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c">## launch xz child</span>
        <span class="n">xz_child</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="p">[</span><span class="s">&#39;xz&#39;</span><span class="p">,</span> <span class="s">&#39;--decompress&#39;</span><span class="p">],</span>
            <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="c">## use communicate to pass the data incrementally to the child</span>
        <span class="c">## while reading the output, to avoid blocking</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">xz_child</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">errors</span><span class="p">,</span> <span class="n">errors</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">xz_compress</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;decompress xz `data` using backports.lzma, or if that&#39;s not</span>
<span class="sd">    available then the commandline `xz --decompress` tool</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">xz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">xz</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;decompress of </span><span class="si">%s</span><span class="s"> bytes failed&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="k">raise</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c">## launch xz child</span>
        <span class="n">xz_child</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="p">[</span><span class="s">&#39;xz&#39;</span><span class="p">,</span> <span class="s">&#39;--compress&#39;</span><span class="p">],</span>
            <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="c">## use communicate to pass the data incrementally to the child</span>
        <span class="c">## while reading the output, to avoid blocking</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">xz_child</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="n">errors</span><span class="p">,</span> <span class="n">errors</span>

    <span class="k">return</span> <span class="n">data</span>


<div class="viewcode-block" id="compress_and_encrypt"><a class="viewcode-back" href="../../sphinx-docs/streamcorpus.html#streamcorpus.compress_and_encrypt">[docs]</a><span class="k">def</span> <span class="nf">compress_and_encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">gpg_public</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">gpg_recipient</span><span class="o">=</span><span class="s">&#39;trec-kba&#39;</span><span class="p">,</span>
                         <span class="n">tmp_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s">&#39;xz&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Given a data buffer of bytes compress it using the `compression`</span>
<span class="sd">    scheme, if gpg_public is provided, encrypt data using gnupg.</span>
<span class="sd">    Compression can be &quot;xz&quot;, &quot;sz&quot;, &quot;gz&quot;, or &quot;&quot;</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">_errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">known_compression_schemes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s">&#39;xz&#39;</span><span class="p">,</span> <span class="s">&#39;gz&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">sz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">known_compression_schemes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;sz&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">compression</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">known_compression_schemes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Unrecognized compression scheme </span><span class="si">%s</span><span class="s"> (known: </span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="n">compression</span><span class="p">,</span> <span class="n">known_compression_schemes</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">compression</span> <span class="o">==</span> <span class="s">&#39;xz&#39;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">xz_compress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">compression</span> <span class="o">==</span> <span class="s">&#39;sz&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sz</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Snappy compression is not available&#39;</span><span class="p">)</span>
        <span class="c">## sz.compress is broken per https://github.com/andrix/python-snappy/issues/28</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">sz</span><span class="o">.</span><span class="n">stream_compress</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">fh</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">compression</span> <span class="o">==</span> <span class="s">&#39;gz&#39;</span><span class="p">:</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">gz_fh</span> <span class="o">=</span> <span class="n">gz</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">fh</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">gz_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">gz_fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">compression</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="ow">or</span> <span class="n">compression</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">gpg_public</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c">### setup gpg for encryption.</span>
        <span class="n">gpg_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">tempnam</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s">&#39;tmp-compress-and-encrypt-&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">gpg_dir</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="c">## Load public key.  Could do this just once, but performance</span>
            <span class="c">## hit is minor and code simpler to do it everytime</span>
            <span class="n">gpg_child</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
                <span class="p">[</span><span class="s">&#39;gpg&#39;</span><span class="p">,</span> <span class="s">&#39;--no-permission-warning&#39;</span><span class="p">,</span> <span class="s">&#39;--homedir&#39;</span><span class="p">,</span> <span class="n">gpg_dir</span><span class="p">,</span>
                 <span class="s">&#39;--import&#39;</span><span class="p">,</span> <span class="n">gpg_public</span><span class="p">],</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="n">s_out</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">gpg_child</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="n">_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;gpg logs to stderr, read carefully:</span><span class="se">\n\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                               <span class="n">errors</span><span class="p">)</span>

            <span class="c">## encrypt using the fingerprint for our trec-kba-rsa key pair</span>
            <span class="n">gpg_child</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
                <span class="c">## setup gpg to decrypt with trec-kba private key</span>
                <span class="c">## (i.e. make it the recipient), with zero compression,</span>
                <span class="c">## ascii armoring is off by default, and --output - must</span>
                <span class="c">## appear before --encrypt -</span>
                <span class="p">[</span><span class="s">&#39;gpg&#39;</span><span class="p">,</span>  <span class="s">&#39;--no-permission-warning&#39;</span><span class="p">,</span> <span class="s">&#39;--homedir&#39;</span><span class="p">,</span> <span class="n">gpg_dir</span><span class="p">,</span>
                 <span class="s">&#39;-r&#39;</span><span class="p">,</span> <span class="n">gpg_recipient</span><span class="p">,</span> <span class="s">&#39;-z&#39;</span><span class="p">,</span> <span class="s">&#39;0&#39;</span><span class="p">,</span> <span class="s">&#39;--trust-model&#39;</span><span class="p">,</span> <span class="s">&#39;always&#39;</span><span class="p">,</span>
                 <span class="s">&#39;--output&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;--encrypt&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">],</span>
                <span class="n">stdin</span> <span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="c">## communicate with child via its stdin</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">gpg_child</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="n">_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">gpg_dir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_errors</span><span class="p">,</span> <span class="n">data</span>

</div>
<span class="n">known_compression_schemes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s">&#39;xz&#39;</span><span class="p">,</span> <span class="s">&#39;gz&#39;</span><span class="p">,</span> <span class="s">&#39;sz&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">])</span>
<span class="n">file_extensions_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;.*?(\.(?P&lt;type&gt;(fc|sc)))?(\.(?P&lt;compression&gt;(xz|gz|sz)))?(\.(?P&lt;encryption&gt;gpg))?$&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_file_extensions</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;accepts a `path` string (can be just a filename) and parses the</span>
<span class="sd">    extensions at the end of the file for up to three different</span>
<span class="sd">    components:  type.compression.encryption</span>

<span class="sd">      &lt;name&gt;.&lt;type=(fc|sc)&gt;.&lt;compression=(xz|gz|sz)&gt;.&lt;encryption=gpg&gt;</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">file_extensions_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;compression&#39;</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;encryption&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="compress_and_encrypt_path"><a class="viewcode-back" href="../../sphinx-docs/streamcorpus.html#streamcorpus.compress_and_encrypt_path">[docs]</a><span class="k">def</span> <span class="nf">compress_and_encrypt_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">gpg_public</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">gpg_recipient</span><span class="o">=</span><span class="s">&#39;trec-kba&#39;</span><span class="p">,</span>
                              <span class="n">compression</span><span class="o">=</span><span class="s">&#39;xz&#39;</span><span class="p">,</span>
                              <span class="n">tmp_dir</span><span class="o">=</span><span class="s">&#39;/tmp&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Given a path in the local file system, compress it using</span>
<span class="sd">    `compression`, which defaults to &quot;xz&quot;, if gpg_public is provided,</span>
<span class="sd">    encrypt data using gnupg.</span>

<span class="sd">    :param compression: can be either &quot;xz&quot;, &quot;sz&quot;, or &quot;&quot;</span>

<span class="sd">    :returns: path to file to a new file containing the of encrypted,</span>
<span class="sd">    compressed data</span>

<span class="sd">    :rtype: str</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">_errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">path</span>

    <span class="k">if</span> <span class="n">compression</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">compression</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="n">commands</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;xz&#39;</span><span class="p">:</span> <span class="s">&#39;xz --compress &lt; &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span>
        <span class="s">&#39;sz&#39;</span><span class="p">:</span> <span class="s">&#39;python -m snappy -c &lt; &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span>
        <span class="s">&#39;gz&#39;</span><span class="p">:</span> <span class="s">&#39;gzip -c &lt; &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span>
        <span class="s">&#39;&#39;</span><span class="p">:</span> <span class="s">&#39;cat &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="n">command</span> <span class="o">=</span> <span class="n">commands</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">compression</span><span class="p">)</span>

    <span class="n">tmp_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s">&#39;tmp-compress-and-encrypt-path-&#39;</span> <span class="o">+</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">gpg_public</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c">### setup gpg for encryption.</span>
        <span class="n">gpg_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="s">&#39;gpg_dir&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">gpg_dir</span><span class="p">)</span>

        <span class="c">## Load public key.  Could do this just once, but performance</span>
        <span class="c">## hit is minor and code simpler to do it everytime</span>
        <span class="n">gpg_child</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="p">[</span><span class="s">&#39;gpg&#39;</span><span class="p">,</span> <span class="s">&#39;--quiet&#39;</span><span class="p">,</span> <span class="s">&#39;--no-permission-warning&#39;</span><span class="p">,</span> <span class="s">&#39;--homedir&#39;</span><span class="p">,</span> <span class="n">gpg_dir</span><span class="p">,</span>
             <span class="s">&#39;--import&#39;</span><span class="p">,</span> <span class="n">gpg_public</span><span class="p">],</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">s_out</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">gpg_child</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">gpg_child</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;gpg setup exited with status {0}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gpg_child</span><span class="o">.</span><span class="n">returncode</span><span class="p">))</span>
            <span class="n">_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;gpg logs to stderr, read carefully:</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">errors</span><span class="p">)</span>

        <span class="c">## setup gpg to decrypt with provided private key (i.e. make</span>
        <span class="c">## it the recipient), with zero compression, ascii armoring is</span>
        <span class="c">## off by default, and --output - must come before --encrypt -</span>
        <span class="n">command</span> <span class="o">+=</span> <span class="s">&#39;| gpg --quiet --no-permission-warning --homedir &#39;</span> <span class="o">+</span> <span class="n">gpg_dir</span> \
                 <span class="o">+</span> <span class="s">&#39; -r &#39;</span> <span class="o">+</span> <span class="n">gpg_recipient</span> \
                 <span class="o">+</span> <span class="s">&#39; -z 0 --trust-model always --output - --encrypt - &#39;</span>

    <span class="c">## we want to capture any errors, so do all the work before</span>
    <span class="c">## returning.  Store the intermediate result in this temp file:</span>
    <span class="n">o_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="s">&#39;o_path&#39;</span><span class="p">)</span>
    <span class="n">e_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="s">&#39;e_path&#39;</span><span class="p">)</span>

    <span class="n">command</span> <span class="o">+=</span> <span class="s">&#39; 1&gt; &#39;</span> <span class="o">+</span> <span class="n">o_path</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;compress_and_encrypt_path command </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">p_stdout</span><span class="p">,</span> <span class="n">p_stderr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="c"># p_stdout should be empty because we&#39;re redirecting to o_path</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;command return code {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">returncode</span><span class="p">))</span>
        <span class="n">_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_stderr</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">p_stderr</span><span class="p">:</span>
        <span class="c"># sometimes returncode is zero on failures</span>
        <span class="n">_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_stderr</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">gpg_public</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">gpg_dir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_errors</span><span class="p">,</span> <span class="n">o_path</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">streamcorpus-pipeline 0.7.10.dev1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-50390027-1', 'streamcorpus.org');
  ga('send', 'pageview');

</script>

  </body>
</html>