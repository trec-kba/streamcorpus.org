<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>kvlayer._abstract_storage &mdash; streamcorpus-pipeline 0.7.10.dev1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.7.10.dev1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="streamcorpus-pipeline 0.7.10.dev1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">streamcorpus-pipeline 0.7.10.dev1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for kvlayer._abstract_storage</h1><div class="highlight"><pre>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Definition of AbstractStorage, which all storage</span>
<span class="sd">implementations inherit.</span>

<span class="sd">Your use of this software is governed by your license agreement.</span>

<span class="sd">Copyright 2012-2015 Diffeo, Inc.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">kvlayer.encoders</span> <span class="kn">import</span> <span class="n">get_encoder</span>
<span class="kn">from</span> <span class="nn">kvlayer._exceptions</span> <span class="kn">import</span> <span class="n">BadKey</span><span class="p">,</span> <span class="n">ConfigurationError</span><span class="p">,</span> <span class="n">ProgrammerError</span>


<span class="k">class</span> <span class="nc">COUNTER</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Integer counter value type.</span>

<span class="sd">    You cannot meaningfully instantiate this class.  Instead, pass</span>
<span class="sd">    it as a value in the `value_types` dictionary parameter to</span>
<span class="sd">    :meth:`AbstractStorage.setup_namespace`.</span>

<span class="sd">    If a table has this value type, then its values are integers,</span>
<span class="sd">    in the same way as if the table had value type</span>
<span class="sd">    :class:`int`; but you can also use the table as a counter</span>
<span class="sd">    using :meth:`AbstractStorage.increment`.</span>

<span class="sd">    &#39;&#39;&#39;</span>


<span class="k">class</span> <span class="nc">ACCUMULATOR</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Floating-point counter value type.</span>

<span class="sd">    You cannot meaningfully instantiate this class.  Instead, pass</span>
<span class="sd">    it as a value in the `value_types` dictionary parameter to</span>
<span class="sd">    :meth:`AbstractStorage.setup_namespace`.</span>

<span class="sd">    If a table has this value type, then its values are floating-point</span>
<span class="sd">    numbers, in the same way as if the table had value type</span>
<span class="sd">    :class:`float`; but you can also use the table as a counter using</span>
<span class="sd">    :meth:`AbstractStorage.increment`.</span>

<span class="sd">    &#39;&#39;&#39;</span>


<div class="viewcode-block" id="AbstractStorage"><a class="viewcode-back" href="../../sphinx-docs/kvlayer.html#kvlayer._abstract_storage.AbstractStorage">[docs]</a><span class="k">class</span> <span class="nc">AbstractStorage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Base class for all low-level storage implementations.</span>

<span class="sd">    All of the table-like structures we use are setup like this::</span>

<span class="sd">        namespace = dict(</span>
<span class="sd">            table_name = dict((UUID, UUID, ...): val)</span>
<span class="sd">            ...</span>
<span class="sd">        )</span>

<span class="sd">    where the number of UUIDs in the key is a configurable parameter</span>
<span class="sd">    of each table, and the &quot;val&quot; is always binary and might be a</span>
<span class="sd">    trivial value, like 1.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span>

<div class="viewcode-block" id="AbstractStorage.check_put_key_value"><a class="viewcode-back" href="../../sphinx-docs/kvlayer.html#kvlayer._abstract_storage.AbstractStorage.check_put_key_value">[docs]</a>    <span class="k">def</span> <span class="nf">check_put_key_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">key_spec</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                            <span class="n">value_type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Check that a key/value pair are consistent with the schema.</span>

<span class="sd">        :param tuple key: key to put</span>
<span class="sd">        :param value: value to put (ignored)</span>
<span class="sd">        :param str table_name: kvlayer table name (for errors only)</span>
<span class="sd">        :param tuple key_spec: definition of the table key</span>
<span class="sd">        :param value_type: type of the table value</span>
<span class="sd">        :raise kvlayer._exceptions.BadKey: if `key` doesn&#39;t match `key_spec`</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">key_spec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">key_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_names</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">value_type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">value_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_types</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">value_type</span> <span class="ow">is</span> <span class="n">COUNTER</span><span class="p">:</span>
            <span class="n">value_type</span> <span class="o">=</span> <span class="nb">int</span>
        <span class="k">if</span> <span class="n">value_type</span> <span class="ow">is</span> <span class="n">ACCUMULATOR</span><span class="p">:</span>
            <span class="n">value_type</span> <span class="o">=</span> <span class="nb">float</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">BadKey</span><span class="p">(</span><span class="s">&#39;key should be tuple, but got </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">),))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_spec</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">BadKey</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s"> wants </span><span class="si">%r</span><span class="s"> parts in key tuple, but got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="n">table_name</span><span class="p">,</span>  <span class="nb">len</span><span class="p">(</span><span class="n">key_spec</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">kp</span><span class="p">,</span> <span class="n">ks</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key_spec</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">ks</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">BadKey</span><span class="p">(</span><span class="s">&#39;part of key wanted type </span><span class="si">%s</span><span class="s"> but got </span><span class="si">%s</span><span class="s">: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">kp</span><span class="p">),</span> <span class="n">kp</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">value_type</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">BadKey</span><span class="p">(</span><span class="s">&#39;value should be </span><span class="si">%s</span><span class="s">, but got </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="n">value_type</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="AbstractStorage.value_to_str"><a class="viewcode-back" href="../../sphinx-docs/kvlayer.html#kvlayer._abstract_storage.AbstractStorage.value_to_str">[docs]</a>    <span class="k">def</span> <span class="nf">value_to_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">value_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">value_type</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">value_type</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">or</span> <span class="n">value_type</span> <span class="ow">is</span> <span class="n">COUNTER</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&gt;i&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value_type</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">or</span> <span class="n">value_type</span> <span class="ow">is</span> <span class="n">ACCUMULATOR</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&gt;f&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s">&#39;unexpected value_type {0!r}&#39;</span>
                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value_type</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="AbstractStorage.str_to_value"><a class="viewcode-back" href="../../sphinx-docs/kvlayer.html#kvlayer._abstract_storage.AbstractStorage.str_to_value">[docs]</a>    <span class="k">def</span> <span class="nf">str_to_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">value_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">value_type</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">value_type</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">or</span> <span class="n">value_type</span> <span class="ow">is</span> <span class="n">COUNTER</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&gt;i&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&gt;q&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">value_type</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">or</span> <span class="n">value_type</span> <span class="ow">is</span> <span class="n">ACCUMULATOR</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&gt;f&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s">&#39;unexpected value_type {0!r}&#39;</span>
                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value_type</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">app_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Initialize a storage instance with config dict.</span>

<span class="sd">        `config` is the configuration for this object; it may come</span>
<span class="sd">        from :mod:`yakonfig` or elsewhere.  If `app_name` or `namespace`</span>
<span class="sd">        are given as arguments to this method, they override the</span>
<span class="sd">        corresponding parameters in the configuration.  These two</span>
<span class="sd">        parameters _must_ be present, if not from the named arguments</span>
<span class="sd">        then in the configuration, otherwise :class:`ConfigurationError`</span>
<span class="sd">        will be raised.</span>

<span class="sd">        This understands the following keys in `config`:</span>

<span class="sd">        `app_name`</span>
<span class="sd">          wrapper name for all namespaces</span>
<span class="sd">        `namespace`</span>
<span class="sd">          wrapper name for all managed tables</span>
<span class="sd">        `storage_addresses`</span>
<span class="sd">          list of locations of data storage; backend-specific</span>
<span class="sd">        `log_stats`</span>
<span class="sd">          if provided, name of a file to which to log statistics</span>
<span class="sd">        `log_stats_interval_ops`</span>
<span class="sd">          if provided, log stats after this many operations</span>
<span class="sd">        `log_stats_interval_seconds`</span>
<span class="sd">          if provided, log stats after this many seconds</span>
<span class="sd">        `encoder`</span>
<span class="sd">          name of a key-to-string encoder, if applicable</span>

<span class="sd">        :param dict config: local configuration dictionary</span>
<span class="sd">        :param str app_name: optional app name override</span>
<span class="sd">        :param str namespace: optional namespace override</span>
<span class="sd">        :param kvlayer.encoders.base.Encoder encoder: key serializer</span>
<span class="sd">        :raise kvlayer._exceptions.ConfigurationError: if no `app_name`</span>
<span class="sd">          or `namespace` could be found</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table_names</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value_types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span> <span class="o">=</span> <span class="n">namespace</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;namespace&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s">&#39;kvlayer requires a namespace&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app_name</span> <span class="o">=</span> <span class="n">app_name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;app_name&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s">&#39;kvlayer requires an app_name&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoder</span> <span class="o">=</span> <span class="n">get_encoder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;encoder&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_require_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;keys_must_be_uuid&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">log_stats_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;log_stats&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="c"># StorageStats also consumes:</span>
        <span class="c">#  log_stats_interval_ops</span>
        <span class="c">#  log_stats_interval_seconds</span>
        <span class="k">if</span> <span class="n">log_stats_cfg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span> <span class="o">=</span> <span class="n">StorageStats</span><span class="p">(</span><span class="n">log_stats_cfg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="AbstractStorage.setup_namespace"><a class="viewcode-back" href="../../sphinx-docs/kvlayer.html#kvlayer._abstract_storage.AbstractStorage.setup_namespace">[docs]</a>    <span class="k">def</span> <span class="nf">setup_namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_names</span><span class="p">,</span> <span class="n">value_types</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create tables in the namespace.</span>

<span class="sd">        Can be run multiple times with different `table_names` in</span>
<span class="sd">        order to expand the set of tables in the namespace.  This</span>
<span class="sd">        generally needs to be called by every client, even if only</span>
<span class="sd">        reading data.</span>

<span class="sd">        Tables are specified by the form of their keys. A key must be</span>
<span class="sd">        a tuple of a set number and type of parts. Currently types</span>
<span class="sd">        :class:`uuid.UUID`, :class:`int`, :class:`long`, and</span>
<span class="sd">        :class:`str` are well supported, anything else is serialzed by</span>
<span class="sd">        :func:`str`. Historically, a kvlayer key had to be a tuple of some</span>
<span class="sd">        number of UUIDs.  `table_names` is a dictionary mapping a</span>
<span class="sd">        table name to a tuple of types.  The dictionary values may also</span>
<span class="sd">        be integers, in which case the tuple is that many UUIDs.</span>

<span class="sd">        `value_types` specifies the type of the values for a given</span>
<span class="sd">        table.  Tables default to having a value type of :class:`str`.</span>
<span class="sd">        :class:`int` and :class:`float` are also permitted.  Value</span>
<span class="sd">        types may also be :class:`COUNTER` or :class:`ACCUMULATOR`;</span>
<span class="sd">        see :meth:`increment` for details on these types.  You must pass</span>
<span class="sd">        the corresponding type as the value parameter to :meth:`put`,</span>
<span class="sd">        and that type will be returned as the value part of</span>
<span class="sd">        :meth:`get` and :meth:`scan`.</span>

<span class="sd">        :param dict table_names: Mapping from table name to key type tuple</span>
<span class="sd">        :param dict value_types: Mapping from table name to value type</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">value_types</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">value_types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># Subclass implementations should call this superclass</span>
        <span class="c"># implementation to actually populate self._table_names.</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">table_names</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">:</span>
                    <span class="c"># This is probably a bug</span>
                    <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                        <span class="s">&#39;excessively long tuple size {0!r} for table {1!r}&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,)</span> <span class="o">*</span> <span class="n">v</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_table_names</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">value_type</span> <span class="o">=</span> <span class="n">value_types</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">COUNTER</span><span class="p">,</span> <span class="n">ACCUMULATOR</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                    <span class="s">&#39;invalid value type {0!r} for table {1!r}&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value_type</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_value_types</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_type</span>
</div>
    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="AbstractStorage.delete_namespace"><a class="viewcode-back" href="../../sphinx-docs/kvlayer.html#kvlayer._abstract_storage.AbstractStorage.delete_namespace">[docs]</a>    <span class="k">def</span> <span class="nf">delete_namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Deletes all data from namespace.&#39;&#39;&#39;</span>
        <span class="k">return</span>
</div>
    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="AbstractStorage.clear_table"><a class="viewcode-back" href="../../sphinx-docs/kvlayer.html#kvlayer._abstract_storage.AbstractStorage.clear_table">[docs]</a>    <span class="k">def</span> <span class="nf">clear_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Delete all data from one table.&#39;&#39;&#39;</span>
        <span class="k">return</span>
</div>
    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="AbstractStorage.put"><a class="viewcode-back" href="../../sphinx-docs/kvlayer.html#kvlayer._abstract_storage.AbstractStorage.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="o">*</span><span class="n">keys_and_values</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Save values for keys in `table_name`.</span>

<span class="sd">        Each key must be a tuple of length and types as specified for</span>
<span class="sd">        `table_name` in :meth:`setup_namespace`.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="AbstractStorage.log_put"><a class="viewcode-back" href="../../sphinx-docs/kvlayer.html#kvlayer._abstract_storage.AbstractStorage.log_put">[docs]</a>    <span class="k">def</span> <span class="nf">log_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">num_keys</span><span class="p">,</span> <span class="n">keys_size</span><span class="p">,</span>
                <span class="n">num_values</span><span class="p">,</span> <span class="n">values_size</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span><span class="o">.</span><span class="n">put</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">num_keys</span><span class="p">,</span>
                                    <span class="n">keys_size</span><span class="p">,</span> <span class="n">num_values</span><span class="p">,</span> <span class="n">values_size</span><span class="p">)</span>
</div>
    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="AbstractStorage.scan"><a class="viewcode-back" href="../../sphinx-docs/kvlayer.html#kvlayer._abstract_storage.AbstractStorage.scan">[docs]</a>    <span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="o">*</span><span class="n">key_ranges</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Yield tuples of (key, value) from querying table_name for</span>
<span class="sd">        items with keys within the specified ranges.  If no key_ranges</span>
<span class="sd">        are provided, then yield all (key, value) pairs in table.</span>
<span class="sd">        This may return nothing if the table is empty or there are</span>
<span class="sd">        no matching keys in any of the specified ranges.</span>

<span class="sd">        Each of the `key_ranges` is a pair of a start and end tuple to</span>
<span class="sd">        scan.  To specify the beginning or end, a -Inf or Inf value,</span>
<span class="sd">        use an empty tuple as the beginning or ending key of a range.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="AbstractStorage.log_scan"><a class="viewcode-back" href="../../sphinx-docs/kvlayer.html#kvlayer._abstract_storage.AbstractStorage.log_scan">[docs]</a>    <span class="k">def</span> <span class="nf">log_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">num_keys</span><span class="p">,</span> <span class="n">keys_size</span><span class="p">,</span>
                 <span class="n">num_values</span><span class="p">,</span> <span class="n">values_size</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">table_name</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span>
                <span class="n">num_keys</span><span class="p">,</span> <span class="n">keys_size</span><span class="p">,</span> <span class="n">num_values</span><span class="p">,</span> <span class="n">values_size</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AbstractStorage.scan_keys"><a class="viewcode-back" href="../../sphinx-docs/kvlayer.html#kvlayer._abstract_storage.AbstractStorage.scan_keys">[docs]</a>    <span class="k">def</span> <span class="nf">scan_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="o">*</span><span class="n">key_ranges</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Scan only the keys from a table.</span>

<span class="sd">        Yields key tuples from queying `table_name` for keys within</span>
<span class="sd">        the specified ranges.  If no `key_ranges` are provided, then</span>
<span class="sd">        yield all key tuples in the table.  This may yield nothing if</span>
<span class="sd">        the table is empty or there are no matching keys in any of the</span>
<span class="sd">        specified ranges.</span>

<span class="sd">        Each of the `key_ranges` is a pair of a start and end tuple to</span>
<span class="sd">        scan.  To specify the beginning or end, a -Inf or Inf value,</span>
<span class="sd">        use an empty tuple as the beginning or ending key of a range.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># Feel free to reimplement this if your backend can do better!</span>
        <span class="c"># we don&#39;t do log_scan_keys() here, let underlying scan() call</span>
        <span class="c"># log_scan()</span>
        <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="o">*</span><span class="n">key_ranges</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="AbstractStorage.log_scan_keys"><a class="viewcode-back" href="../../sphinx-docs/kvlayer.html#kvlayer._abstract_storage.AbstractStorage.log_scan_keys">[docs]</a>    <span class="k">def</span> <span class="nf">log_scan_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">num_keys</span><span class="p">,</span>
                      <span class="n">keys_size</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span><span class="o">.</span><span class="n">scan_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span>
                                          <span class="n">num_keys</span><span class="p">,</span> <span class="n">keys_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="AbstractStorage.get"><a class="viewcode-back" href="../../sphinx-docs/kvlayer.html#kvlayer._abstract_storage.AbstractStorage.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Yield tuples of (key, value) from querying table_name for items</span>
<span class="sd">        with keys.  If any of the key tuples are not in the table,</span>
<span class="sd">        those key tuples will be yielded with value :const:`None`.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="AbstractStorage.log_get"><a class="viewcode-back" href="../../sphinx-docs/kvlayer.html#kvlayer._abstract_storage.AbstractStorage.log_get">[docs]</a>    <span class="k">def</span> <span class="nf">log_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">num_keys</span><span class="p">,</span> <span class="n">keys_size</span><span class="p">,</span>
                <span class="n">num_values</span><span class="p">,</span> <span class="n">values_size</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">table_name</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span>
                <span class="n">num_keys</span><span class="p">,</span> <span class="n">keys_size</span><span class="p">,</span> <span class="n">num_values</span><span class="p">,</span> <span class="n">values_size</span><span class="p">)</span>
</div>
    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="AbstractStorage.delete"><a class="viewcode-back" href="../../sphinx-docs/kvlayer.html#kvlayer._abstract_storage.AbstractStorage.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Delete all (key, value) pairs with specififed keys</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="AbstractStorage.log_delete"><a class="viewcode-back" href="../../sphinx-docs/kvlayer.html#kvlayer._abstract_storage.AbstractStorage.log_delete">[docs]</a>    <span class="k">def</span> <span class="nf">log_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">num_keys</span><span class="p">,</span>
                   <span class="n">keys_size</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span><span class="o">.</span><span class="n">delete</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span>
                                       <span class="n">num_keys</span><span class="p">,</span> <span class="n">keys_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="AbstractStorage.close"><a class="viewcode-back" href="../../sphinx-docs/kvlayer.html#kvlayer._abstract_storage.AbstractStorage.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        close connections and end use of this storage client</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="AbstractStorage.increment"><a class="viewcode-back" href="../../sphinx-docs/kvlayer.html#kvlayer._abstract_storage.AbstractStorage.increment">[docs]</a>    <span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="o">*</span><span class="n">keys_and_values</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add values to a counter-type table.</span>

<span class="sd">        `keys_and_values` are parameters of `(key, value)` pairs.  The</span>
<span class="sd">        values must be :class:`int`, if `table_name` is a</span>
<span class="sd">        :class:`COUNTER` table, or :class:`float`, if `table_name` is</span>
<span class="sd">        a :class:`ACCUMULATOR` table.  For each key, the current value</span>
<span class="sd">        is fetched from the storage, the value is added to it, and the</span>
<span class="sd">        resulting value added back into the storage.</span>

<span class="sd">        This method is not guaranteed to be atomic, either on a</span>
<span class="sd">        specific key or across all keys, but specific backends may</span>
<span class="sd">        have better guarantees.  The behavior is unspecified if the</span>
<span class="sd">        same key is included multiple times in the parameter list.</span>

<span class="sd">        To use this, you must have passed `table_name` to</span>
<span class="sd">        :meth:`setup_namespaces` in its `value_types` parameter,</span>
<span class="sd">        setting the value type to :data:`COUNTER` or</span>
<span class="sd">        :data:`ACCUMULATOR`.  When you do this, you pass and receive</span>
<span class="sd">        :class:`float` values back from all methods in this class for</span>
<span class="sd">        that table.  :meth:`put` directly sets the values of counter</span>
<span class="sd">        keys.  Counter values default to 0; if you change a counter</span>
<span class="sd">        value to 0 then it will be &quot;present&quot; for purposes of</span>
<span class="sd">        :meth:`get`, :meth:`scan`, and :meth:`scan_keys`.</span>

<span class="sd">        :param str table_name: name of table to update</span>
<span class="sd">        :param keys_and_values: additional parameters are pairs of</span>
<span class="sd">          key tuple and numeric delta value</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_types</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">COUNTER</span><span class="p">,</span> <span class="n">ACCUMULATOR</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">ProgrammerError</span><span class="p">(</span><span class="s">&#39;table {0} is not a counter table&#39;</span>
                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>
        <span class="c"># Default, non-atomic implementation</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">keys_and_values</span><span class="p">]</span>
        <span class="n">deltas</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">keys_and_values</span><span class="p">]</span>
        <span class="n">old_keys_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">)</span>
        <span class="n">new_keys_values</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">v</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">d</span><span class="p">)</span>
                           <span class="k">for</span> <span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span> <span class="n">d</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">old_keys_values</span><span class="p">,</span> <span class="n">deltas</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="o">*</span><span class="n">new_keys_values</span><span class="p">)</span>

</div></div>
<span class="k">class</span> <span class="nc">StringKeyedStorage</span><span class="p">(</span><span class="n">AbstractStorage</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Partial implementation of AbstractStorage using string keys.</span>

<span class="sd">    This assumes that the underlying database only can deal in byte-string</span>
<span class="sd">    keys, and :attr:`encoder` needs to be used to generate keys and values.</span>
<span class="sd">    This provides wrappers that do the encoding and basic stats gathering,</span>
<span class="sd">    requiring derived classes to only provide the underlying machinery.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="o">*</span><span class="n">keys_and_values</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">keys_and_values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_put_key_value</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
        <span class="n">ks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoder</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_names</span><span class="p">[</span><span class="n">table_name</span><span class="p">])</span>
              <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">keys_and_values</span><span class="p">]</span>
        <span class="n">vs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">value_to_str</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_types</span><span class="p">[</span><span class="n">table_name</span><span class="p">])</span>
              <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">keys_and_values</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_put</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">vs</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span><span class="o">.</span><span class="n">put</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span>
                                    <span class="nb">len</span><span class="p">(</span><span class="n">ks</span><span class="p">),</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ks</span><span class="p">),</span>
                                    <span class="nb">len</span><span class="p">(</span><span class="n">vs</span><span class="p">),</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vs</span><span class="p">))</span>

    <span class="nd">@abc.abstractmethod</span>
    <span class="k">def</span> <span class="nf">_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">keys_and_values</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="o">*</span><span class="n">key_ranges</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">StatRecord</span><span class="p">()</span>
        <span class="n">key_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_names</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span>
        <span class="n">value_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_types</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span>
        <span class="n">new_key_ranges</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoder</span><span class="o">.</span><span class="n">make_start_key</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">key_spec</span><span class="p">),</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_encoder</span><span class="o">.</span><span class="n">make_end_key</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">key_spec</span><span class="p">))</span>
                          <span class="k">for</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="n">key_ranges</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">new_key_ranges</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="k">yield</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoder</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">key_spec</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">str_to_value</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">value_type</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">add_rec</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span>

    <span class="nd">@abc.abstractmethod</span>
    <span class="k">def</span> <span class="nf">_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">key_ranges</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">scan_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="o">*</span><span class="n">key_ranges</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">StatRecord</span><span class="p">()</span>
        <span class="n">key_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_names</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span>
        <span class="n">new_key_ranges</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoder</span><span class="o">.</span><span class="n">make_start_key</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">key_spec</span><span class="p">),</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_encoder</span><span class="o">.</span><span class="n">make_end_key</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">key_spec</span><span class="p">))</span>
                          <span class="k">for</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="n">key_ranges</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan_keys</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">new_key_ranges</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encoder</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">key_spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span><span class="o">.</span><span class="n">scan_keys</span><span class="o">.</span><span class="n">add_rec</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scan_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">key_ranges</span><span class="p">):</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">key_ranges</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">k</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">StatRecord</span><span class="p">()</span>
        <span class="n">key_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_names</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span>
        <span class="n">value_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_types</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span>
        <span class="n">new_keys</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoder</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">key_spec</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">new_keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">stats</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stats</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="k">yield</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoder</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">key_spec</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">str_to_value</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">value_type</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">add_rec</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span>

    <span class="nd">@abc.abstractmethod</span>
    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">key_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_names</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span>
        <span class="n">new_keys</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoder</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">key_spec</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delete</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">new_keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_stats</span><span class="o">.</span><span class="n">delete</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">table_name</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">new_keys</span><span class="p">),</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">new_keys</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="nd">@abc.abstractmethod</span>
    <span class="k">def</span> <span class="nf">_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="c"># I may have built this inside-out.</span>
<span class="c"># Maybe the top level split should be on table, and keep stats of ops within</span>
<span class="c"># that.  It shouldn&#39;t be hard to transpose for display if needed.</span>
<span class="k">class</span> <span class="nc">StorageStats</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_str_or_writeable</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_str</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config_str_or_writeable</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="o">=</span> <span class="n">config_str_or_writeable</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_json</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;json&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_str_or_writeable</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config_str</span> <span class="o">=</span> <span class="n">config_str_or_writeable</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.json&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;json&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interval_ops</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;log_stats_interval_ops&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval_ops</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interval_ops</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interval_ops</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval_ops</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_interval_ops</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_op_interval_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interval_seconds</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;log_stats_interval_seconds&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interval_seconds</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interval_seconds</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval_seconds</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_interval_seconds</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interval_s_last_flushed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">OpStats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan</span> <span class="o">=</span> <span class="n">OpStats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan_keys</span> <span class="o">=</span> <span class="n">OpStats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">OpStats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete</span> <span class="o">=</span> <span class="n">OpStats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atexit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">outparts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="o">.</span><span class="n">num_ops</span><span class="p">:</span>
            <span class="n">outparts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;put:&#39;</span><span class="p">)</span>
            <span class="n">outparts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">num_ops</span><span class="p">:</span>
            <span class="n">outparts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;scan:&#39;</span><span class="p">)</span>
            <span class="n">outparts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_keys</span><span class="o">.</span><span class="n">num_ops</span><span class="p">:</span>
            <span class="n">outparts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;scan_keys:&#39;</span><span class="p">)</span>
            <span class="n">outparts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_keys</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">num_ops</span><span class="p">:</span>
            <span class="n">outparts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;get:&#39;</span><span class="p">)</span>
            <span class="n">outparts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="o">.</span><span class="n">num_ops</span><span class="p">:</span>
            <span class="n">outparts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;delete:&#39;</span><span class="p">)</span>
            <span class="n">outparts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">))</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outparts</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;return a dict suitable for json.dump()&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="o">.</span><span class="n">num_ops</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&#39;put&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">num_ops</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&#39;scan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_keys</span><span class="o">.</span><span class="n">num_ops</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&#39;scan_keys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_keys</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">num_ops</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&#39;get&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="o">.</span><span class="n">num_ops</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&#39;delete&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_out</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_str</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_str</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_str</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span>

    <span class="k">def</span> <span class="nf">did_op</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval_ops</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_op_interval_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op_interval_counter</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval_ops</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_interval_s_last_flushed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_op_interval_counter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval_s_last_flushed</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval_seconds</span> <span class="o">&lt;</span> <span class="n">now</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_interval_s_last_flushed</span> <span class="o">=</span> <span class="n">now</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_op_interval_counter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">return</span>

    <span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">writeable</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;times&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y%m</span><span class="si">%d</span><span class="s">_%H%M%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">now</span><span class="p">))</span>
        <span class="n">writeable</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_json</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y%m</span><span class="si">%d</span><span class="s">_%H%M%S</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">))</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__str__</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&#39;flush&#39;</span><span class="p">):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">,</span> <span class="s">&#39;close&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">atexit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">OpStats</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parentStorageStats</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">by_table</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">OpStatsPerTable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_ops</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_psto</span> <span class="o">=</span> <span class="n">parentStorageStats</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">num_keys</span><span class="p">,</span> <span class="n">keys_size</span><span class="p">,</span>
            <span class="n">num_values</span><span class="p">,</span> <span class="n">values_size</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_ops</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">by_table</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span>
                                      <span class="n">num_keys</span><span class="p">,</span> <span class="n">keys_size</span><span class="p">,</span>
                                      <span class="n">num_values</span><span class="p">,</span> <span class="n">values_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_psto</span><span class="o">.</span><span class="n">did_op</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Variant of :meth:`add` taking a :class:`StatRecord`.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                        <span class="n">record</span><span class="o">.</span><span class="n">num_keys</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">keys_size</span><span class="p">,</span>
                        <span class="n">record</span><span class="o">.</span><span class="n">num_values</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">values_size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">OpStatsPerTable</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_table</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">v</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;{0:10s} {1}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;           {0}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">total</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;return a dict suitable for json.dump()&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_table</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">out</span>


<span class="k">class</span> <span class="nc">OpStatsPerTable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_ops</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_keys</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keys_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_values</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values_size</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">num_keys</span><span class="p">,</span> <span class="n">keys_size</span><span class="p">,</span> <span class="n">num_values</span><span class="p">,</span>
            <span class="n">values_size</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span> <span class="o">+=</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_ops</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_keys</span> <span class="o">+=</span> <span class="n">num_keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keys_size</span> <span class="o">+=</span> <span class="n">keys_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_values</span> <span class="o">+=</span> <span class="n">num_values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values_size</span> <span class="o">+=</span> <span class="n">values_size</span>

    <span class="k">def</span> <span class="nf">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">OpStatsPerTable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span> <span class="o">+=</span> <span class="n">b</span><span class="o">.</span><span class="n">total_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_ops</span> <span class="o">+=</span> <span class="n">b</span><span class="o">.</span><span class="n">num_ops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_keys</span> <span class="o">+=</span> <span class="n">b</span><span class="o">.</span><span class="n">num_keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keys_size</span> <span class="o">+=</span> <span class="n">b</span><span class="o">.</span><span class="n">keys_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_values</span> <span class="o">+=</span> <span class="n">b</span><span class="o">.</span><span class="n">num_values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values_size</span> <span class="o">+=</span> <span class="n">b</span><span class="o">.</span><span class="n">values_size</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;{t:0.3f}s on {ops} ops ({spops:0.6g} s/op), &#39;</span>
               <span class="s">&#39;{k} keys for {kb} bytes ({bpk} B/key)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                   <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">total_time</span><span class="p">,</span>
                   <span class="n">ops</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_ops</span><span class="p">,</span>
                   <span class="n">spops</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_ops</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_time</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">num_ops</span><span class="p">),</span>
                   <span class="n">k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_keys</span><span class="p">,</span>
                   <span class="n">kb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">keys_size</span><span class="p">,</span>
                   <span class="n">bpk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_keys</span> <span class="ow">and</span> <span class="p">((</span><span class="mf">1.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">keys_size</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">num_keys</span><span class="p">)</span>
               <span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s">&#39;{v} values for {vb} bytes ({bpv:0.1f} B/val)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_values</span><span class="p">,</span>
                <span class="n">vb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">values_size</span><span class="p">,</span>
                <span class="n">bpv</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">values_size</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">num_values</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s">&#39; {0:0.1f} (k+v)B/s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_size</span><span class="p">))</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">total_time</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;return a dict suitable for json.dump()&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;t&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span><span class="p">,</span>
            <span class="s">&#39;ops&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_ops</span><span class="p">,</span>
            <span class="s">&#39;k&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_keys</span><span class="p">,</span>
            <span class="s">&#39;kb&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys_size</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&#39;v&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_values</span>
            <span class="n">out</span><span class="p">[</span><span class="s">&#39;vb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_size</span>
        <span class="k">return</span> <span class="n">out</span>


<span class="k">class</span> <span class="nc">StatRecord</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Combined statistics record for a single action.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c">#: Starting time of the action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c">#: Number of keys processed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_keys</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c">#: Total byte size of keys processed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keys_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c">#: Number of values processed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_values</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c">#: Total byte size of values processed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values_size</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_size</span><span class="p">,</span> <span class="n">value_size</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add a single item to the record.</span>

<span class="sd">        Either `key_size` or `value_size` may be :const:`None`; if so then</span>
<span class="sd">        don&#39;t count that part.  :meth:`AbstractStorage.scan_keys`</span>
<span class="sd">        implementations will typically pass :const:`None` for `value_size`,</span>
<span class="sd">        for instance.  Otherwise increment the relevant counts and add</span>
<span class="sd">        the relevant byte sizes.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">key_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_keys</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keys_size</span> <span class="o">+=</span> <span class="n">key_size</span>
        <span class="k">if</span> <span class="n">value_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_values</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values_size</span> <span class="o">+=</span> <span class="n">value_size</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">streamcorpus-pipeline 0.7.10.dev1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-50390027-1', 'streamcorpus.org');
  ga('send', 'pageview');

</script>

  </body>
</html>