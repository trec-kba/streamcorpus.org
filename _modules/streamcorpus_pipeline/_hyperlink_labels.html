<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>streamcorpus_pipeline._hyperlink_labels &mdash; streamcorpus-pipeline 0.7.10.dev1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.7.10.dev1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="streamcorpus-pipeline 0.7.10.dev1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">streamcorpus-pipeline 0.7.10.dev1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for streamcorpus_pipeline._hyperlink_labels</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Pipeline stage for extracting hyperlinks to particular domains as</span>
<span class="sd">labels generated by the author.</span>

<span class="sd">This software is released under an MIT/X11 open source license.</span>

<span class="sd">Copyright 2012-2014 Diffeo, Inc.</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">streamcorpus</span> <span class="kn">import</span> <span class="n">add_annotation</span><span class="p">,</span> <span class="n">Offset</span><span class="p">,</span> <span class="n">OffsetType</span><span class="p">,</span> <span class="n">Annotator</span><span class="p">,</span> <span class="n">Target</span><span class="p">,</span> <span class="n">Label</span>
<span class="kn">from</span> <span class="nn">streamcorpus_pipeline._clean_visible</span> <span class="kn">import</span> <span class="n">make_clean_visible</span>
<span class="kn">from</span> <span class="nn">streamcorpus_pipeline.stages</span> <span class="kn">import</span> <span class="n">Configured</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">anchors_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;&#39;&#39;(?P&lt;before&gt;(.|</span><span class="se">\n</span><span class="s">)*?)&#39;&#39;&#39;</span> <span class="o">+</span> \
                        <span class="sd">&#39;&#39;&#39;(?P&lt;ahref&gt;\&lt;a\s+(.|\n)*?href&#39;&#39;&#39;</span> <span class="o">+</span> \
                        <span class="sd">&#39;&#39;&#39;(?P&lt;preequals&gt;(\s|\n)*)=(?P&lt;postequals&gt;(\s|\n)*)&#39;&#39;&#39;</span> <span class="o">+</span> \
                        <span class="sd">&#39;&#39;&#39;(?P&lt;quote&gt;(&quot;|&#39;)?)(?P&lt;href&gt;[^&quot;]*)(?P=quote)&#39;&#39;&#39;</span> <span class="o">+</span> \
                        <span class="sd">&#39;&#39;&#39;(?P&lt;posthref&gt;(.|\n)*?)\&gt;)&#39;&#39;&#39;</span> <span class="o">+</span> \
                        <span class="sd">&#39;&#39;&#39;(?P&lt;anchor&gt;(.|\n)*)&#39;&#39;&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">read_to</span><span class="p">(</span> <span class="n">idx_bytes</span><span class="p">,</span> <span class="n">stop_bytes</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">run_bytes</span><span class="o">=</span><span class="bp">None</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    iterates through idx_bytes until a byte in stop_bytes or a byte</span>
<span class="sd">    not in run_bytes.</span>

<span class="sd">    :rtype (int, string): idx of last byte and all of bytes including</span>
<span class="sd">    the terminal byte from stop_bytes or not in run_bytes</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">next_b</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">idx</span><span class="p">,</span> <span class="n">next_b</span> <span class="o">=</span> <span class="n">idx_bytes</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="c">## maybe something going wrong?</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">next_b</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">break</span>
        <span class="c">## stop when we see any byte in stop_bytes</span>
        <span class="k">if</span> <span class="n">stop_bytes</span> <span class="ow">and</span> <span class="n">next_b</span> <span class="ow">in</span> <span class="n">stop_bytes</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="c">## stop when we see any byte not in run_bytes</span>
        <span class="k">if</span> <span class="n">run_bytes</span> <span class="ow">and</span> <span class="n">next_b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">run_bytes</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="c">## assemble the ret_val</span>
        <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">next_b</span> <span class="p">)</span>

    <span class="c">## return whatever we have assembled</span>
    <span class="k">return</span> <span class="n">idx</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vals</span><span class="p">),</span> <span class="n">next_b</span>


<span class="k">def</span> <span class="nf">iter_attrs</span><span class="p">(</span> <span class="n">idx_bytes</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    called when idx_chars is just past &quot;&lt;a &quot; inside an HTML anchor tag</span>
<span class="sd">    </span>
<span class="sd">    generates tuple(end_idx, attr_name, attr_value)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c">## read to the end of the &quot;A&quot; tag</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">idx</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">next_b</span> <span class="o">=</span> <span class="n">read_to</span><span class="p">(</span><span class="n">idx_bytes</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="s">&#39;&gt;&#39;</span><span class="p">])</span>
        <span class="n">attr_vals</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c">## stop if we hit the end of the tag, or end of idx_bytes</span>
        <span class="k">if</span> <span class="n">next_b</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">next_b</span> <span class="o">==</span> <span class="s">&#39;&gt;&#39;</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="n">idx</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="n">quote</span> <span class="o">=</span> <span class="n">read_to</span><span class="p">(</span><span class="n">idx_bytes</span><span class="p">,</span> <span class="n">run_bytes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">quote</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">&quot;&#39;&quot;</span><span class="p">]:</span>
            <span class="c">## caught start of the property value</span>
            <span class="n">attr_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">quote</span><span class="p">]</span>
            <span class="n">quote</span> <span class="o">=</span> <span class="s">&#39; &#39;</span>
        
        <span class="n">idx</span><span class="p">,</span> <span class="n">attr_val</span><span class="p">,</span> <span class="n">next_b</span> <span class="o">=</span> <span class="n">read_to</span><span class="p">(</span><span class="n">idx_bytes</span><span class="p">,</span> <span class="p">[</span><span class="n">quote</span><span class="p">,</span> <span class="s">&#39;&gt;&#39;</span><span class="p">])</span>
        <span class="c">## next_b had better either balance the start quote, end the</span>
        <span class="c">## tag, or end idx_bytes</span>
        <span class="k">assert</span> <span class="n">next_b</span> <span class="ow">in</span> <span class="p">[</span><span class="n">quote</span><span class="p">,</span> <span class="s">&#39;&gt;&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span> <span class="n">attr_val</span>
        <span class="n">attr_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">attr_val</span> <span class="p">)</span>

        <span class="k">yield</span> <span class="n">idx</span><span class="p">,</span> <span class="n">attr_name</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attr_vals</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>        


<div class="viewcode-block" id="hyperlink_labels"><a class="viewcode-back" href="../../sphinx-docs/streamcorpus_pipeline.html#streamcorpus_pipeline._hyperlink_labels.hyperlink_labels">[docs]</a><span class="k">class</span> <span class="nc">hyperlink_labels</span><span class="p">(</span><span class="n">Configured</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Creates document labels from hyperlinks in ``body.clean_html``.</span>

<span class="sd">    The labels are attached to the stream item body with an annotator</span>
<span class="sd">    ID of ``author``.  Any HTML ``&lt;a href=&quot;...&quot;&gt;`` matching the selection</span>
<span class="sd">    criteria will be turned into a label.</span>

<span class="sd">    You generally must set either ``all_domains`` or</span>
<span class="sd">    ``domain_substrings``.  A typical configuration will look like:</span>

<span class="sd">    .. code-block:: yaml</span>

<span class="sd">        streamcorpus_pipeline:</span>
<span class="sd">          incremental_transforms: [ ..., hyperlink_labels, ... ]</span>
<span class="sd">          hyperlink_labels:</span>
<span class="sd">            require_abs_url: true</span>
<span class="sd">            domain_substrings: [ &quot;trec-kba.org&quot; ]</span>

<span class="sd">    Configuration options:</span>

<span class="sd">    .. code-block:: yaml</span>

<span class="sd">        all_domains: false</span>
<span class="sd">        domain_substrings: [ &#39;trec-kba.org&#39; ]</span>

<span class="sd">    A label will only be produced if ``all_domains`` is true, or if</span>
<span class="sd">    the hostname part of the URL has one of ``domain_substrings`` as a</span>
<span class="sd">    substring.  Note that the default configuration is ``all_domains``</span>
<span class="sd">    false and an empty ``domain_substrings`` list, so no labels will</span>
<span class="sd">    be produced without additional configuration.</span>

<span class="sd">    .. code-block:: yaml</span>

<span class="sd">        require_abs_url: true</span>

<span class="sd">    Only produce labels for fully-qualified ``http://...`` URLs.  False</span>
<span class="sd">    by default.</span>

<span class="sd">    .. code-block:: yaml</span>

<span class="sd">        offset_types: [BYTES]</span>

<span class="sd">    A list containing at least one of ``BYTES`` and ``LINES``</span>
<span class="sd">    indicating what sort of document offset should be attached to the</span>
<span class="sd">    label.  Only the first value is used.  ``LINES`` is not</span>
<span class="sd">    recommended.</span>

<span class="sd">    .. code-block:: yaml</span>

<span class="sd">        require_clean_html: true</span>

<span class="sd">    Cannot be changed.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">config_name</span> <span class="o">=</span> <span class="s">&#39;hyperlink_labels&#39;</span>
    <span class="n">default_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;require_clean_html&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="s">&#39;require_abs_url&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&#39;all_domains&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&#39;domain_substrings&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s">&#39;offset_types&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;BYTES&#39;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">hyperlink_labels</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">OffsetType</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;offset_types&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset_type</span> <span class="o">!=</span> <span class="n">OffsetType</span><span class="o">.</span><span class="n">BYTES</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;using offset_type other than BYTES: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">href_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">href</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Test whether an href string meets criteria specified by</span>
<span class="sd">        configuration parameters &#39;require_abs_url&#39;, which means &quot;does</span>
<span class="sd">        it look like it is probably an absolute URL?&quot; and</span>
<span class="sd">        &#39;domain_substrings&#39;.  It searches for each of the</span>
<span class="sd">        domain_substrings in the href individually, and if any match,</span>
<span class="sd">        then returns True.</span>

<span class="sd">        :param: href string</span>
<span class="sd">        :returns bool:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;require_abs_url&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">href</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s">&#39;http://&#39;</span><span class="p">,</span> <span class="s">&#39;https://&#39;</span><span class="p">)):</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;all_domains&#39;</span><span class="p">]:</span>
            <span class="c">## blanket accept all domains as labels</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;domain_substrings&#39;</span><span class="p">]:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">href</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">substring</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;domain_substrings&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">substring</span> <span class="ow">in</span> <span class="n">domain</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">True</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s"> in </span><span class="si">%r</span><span class="s"> raised&#39;</span><span class="p">,</span> <span class="n">substring</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">False</span>


    <span class="k">def</span> <span class="nf">line_href_anchors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        simple, regex-based extractor of anchor tags, so we can</span>
<span class="sd">        compute LINE offsets for anchor texts and associate them with</span>
<span class="sd">        their href.</span>
<span class="sd">        </span>
<span class="sd">        Generates tuple(href_string, first_byte, byte_length, anchor_text)</span>

<span class="sd">        Also, this mangles the body.clean_html so that LINE offsets</span>
<span class="sd">        uniquely identify tokens in anchor tags -- quite a kludge.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">new_clean_html</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">newlines_added</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c">## split doc up into pieces that end on an anchor tag</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_html</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;&lt;/a&gt;&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="s">&#39;&lt;/a&gt;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_html</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)):</span>
            <span class="n">part</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c">## try to get an A tag out:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">anchors_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>

            <span class="c">## if not, then just keep going</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">new_clean_html</span> <span class="o">+=</span> <span class="n">part</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">new_clean_html</span> <span class="o">+=</span> <span class="s">&#39;&lt;/a&gt;&#39;</span>
                <span class="k">continue</span>

            <span class="n">before</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;before&#39;</span><span class="p">)</span>
            <span class="n">ahref</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;ahref&#39;</span><span class="p">)</span>

            <span class="c">## construct a text containing bytes up to the anchor text</span>
            <span class="n">pre_anchor_increment</span> <span class="o">=</span> <span class="n">before</span> <span class="o">+</span> <span class="n">ahref</span>

            <span class="c">## increment the index to get line number for the anchor</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">pre_anchor_increment</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="p">)</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">idx</span>

            <span class="c">## usually this will be one, but it could be more than</span>
            <span class="c">## that when an anchor text contains newlines</span>
            <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;anchor&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">))</span>

            <span class="c">## construct new clean_html with these newlines inserted</span>
            <span class="n">new_clean_html</span> <span class="o">+=</span> <span class="n">pre_anchor_increment</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;anchor&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&lt;/a&gt;&#39;</span>

            <span class="n">newlines_added</span> <span class="o">+=</span> <span class="mi">2</span>

            <span class="c">## update the index for the next loop</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="k">yield</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">),</span> <span class="n">first</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;anchor&#39;</span><span class="p">)</span>

        <span class="c">## replace clean_html with our new one that has newlines inserted</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_html</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_clean_html</span><span class="p">)</span> <span class="o">-</span> <span class="n">newlines_added</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_html</span> <span class="o">=</span> <span class="n">new_clean_html</span>

    <span class="k">def</span> <span class="nf">char_href_anchors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chars</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">byte_href_anchors</span><span class="p">(</span><span class="n">chars</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">tup</span>

    <span class="k">def</span> <span class="nf">byte_href_anchors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chars</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        simple, regex-based extractor of anchor tags, so we can</span>
<span class="sd">        compute BYTE offsets for anchor texts and associate them with</span>
<span class="sd">        their href.</span>
<span class="sd">        </span>
<span class="sd">        Generates tuple(href_string, first_byte, byte_length, anchor_text)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">input_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_html</span>
        <span class="k">if</span> <span class="n">chars</span><span class="p">:</span>
            <span class="n">input_buffer</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c">## split doc up into pieces that end on an anchor tag</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">input_buffer</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;&lt;/a&gt;&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="s">&#39;&lt;/a&gt;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_buffer</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
            <span class="c">## try to get an A tag out:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">anchors_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span>
                <span class="k">continue</span>

            <span class="n">before</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;before&#39;</span><span class="p">)</span>
            <span class="n">ahref</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;ahref&#39;</span><span class="p">)</span>

            <span class="c">## increment the index to get line number for the anchor</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">before</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">ahref</span><span class="p">)</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">idx</span>

            <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;anchor&#39;</span><span class="p">))</span>

            <span class="c">## update the index for the next loop</span>
            <span class="c"># include anchor plus the &lt;/a&gt;</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="n">length</span> <span class="o">+</span> <span class="mi">4</span>

            <span class="k">if</span> <span class="n">chars</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">),</span> <span class="n">first</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;anchor&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">),</span> <span class="n">first</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;anchor&#39;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_buffer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">byte_href_anchors_state_machine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        byte-based state machine extractor of anchor tags, so we can</span>
<span class="sd">        compute byte offsets for anchor texts and associate them with</span>
<span class="sd">        their href.</span>
<span class="sd">        </span>
<span class="sd">        Generates tuple(href_string, first_byte, byte_length, anchor_text)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">tag_depth</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">a_tag_depth</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">href</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">idx_bytes</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_html</span> <span class="p">)</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">end_idx</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">next_b</span> <span class="o">=</span> <span class="n">read_to</span><span class="p">(</span> <span class="n">idx_bytes</span><span class="p">,</span> <span class="s">&#39;&lt;&#39;</span> <span class="p">)</span>
            <span class="n">tag_depth</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">href</span><span class="p">:</span>
                <span class="c">## must be inside an anchor tag, so accumulate the</span>
                <span class="c">## whole anchor</span>
                <span class="k">assert</span> <span class="n">a_tag_depth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">href</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_html</span><span class="p">)</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

            <span class="c">## figure out if start of an &quot;A&quot; anchor tag or close</span>
            <span class="c">## of a previous tag</span>
            <span class="n">idx</span><span class="p">,</span> <span class="n">next_b1</span> <span class="o">=</span> <span class="n">idx_bytes</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">next_b1</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;a&#39;</span><span class="p">:</span>
                <span class="c">## could be start of &quot;A&quot; tag</span>
                <span class="n">idx</span><span class="p">,</span> <span class="n">next_b2</span> <span class="o">=</span> <span class="n">idx_bytes</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">next_b2</span> <span class="o">==</span> <span class="s">&#39; &#39;</span><span class="p">:</span>
                    <span class="n">a_tag_depth</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="n">href</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_val</span> <span class="ow">in</span> <span class="n">iter_attrs</span><span class="p">(</span> <span class="n">idx_bytes</span> <span class="p">):</span>
                        <span class="k">if</span> <span class="n">attr_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;href&#39;</span><span class="p">:</span>
                            <span class="n">href</span> <span class="o">=</span> <span class="n">attr_val</span>
                        <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="c">## doc ended mid tag, so invalid HTML--&gt; just bail</span>
                            <span class="k">return</span>

                    <span class="n">first</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="c">## if we got an href, then we want to keep the</span>
                    <span class="c">## first byte idx of the anchor:</span>
                    <span class="k">if</span> <span class="n">href</span><span class="p">:</span>
                        <span class="c">## Someone could nest an A tag inside another</span>
                        <span class="c">## A tag, which is invalid (even in HTML5), so</span>
                        <span class="c">## vals could be nonempty.  We only generate</span>
                        <span class="c">## the leaf-level A tags in these rare cases</span>
                        <span class="c">## of nested A tags, so reset it:</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">elif</span> <span class="n">next_b1</span> <span class="o">==</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
                <span class="n">idx</span><span class="p">,</span> <span class="n">next_b1</span> <span class="o">=</span> <span class="n">idx_bytes</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">next_b1</span> <span class="o">==</span> <span class="s">&#39;a&#39;</span><span class="p">:</span>
                    <span class="c">## could be end of &quot;A&quot; tag</span>
                    <span class="n">idx</span><span class="p">,</span> <span class="n">next_b2</span> <span class="o">=</span> <span class="n">idx_bytes</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">next_b2</span> <span class="o">==</span> <span class="s">&#39;&gt;&#39;</span><span class="p">:</span>
                        <span class="n">a_tag_depth</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">href</span><span class="p">:</span>
                            <span class="c">## join is much faster than using += above</span>
                            <span class="n">anchor</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
                            <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">anchor</span><span class="p">)</span>

                            <span class="c">## yield the data</span>
                            <span class="k">yield</span> <span class="n">href</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">anchor</span><span class="p">),</span> <span class="n">anchor</span>

                            <span class="c">## reset, no yield again in a nested A tag</span>
                            <span class="n">href</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c">## the next_b was not part of &lt;/a&gt; or a nested &lt;a tag,</span>
                <span class="c">## so keep it in the output</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_b</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">make_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clean_html</span><span class="p">,</span> <span class="n">clean_visible</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Make a list of Labels for &#39;author&#39; and the filtered hrefs &amp;</span>
<span class="sd">        anchors</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span>   <span class="bp">self</span><span class="o">.</span><span class="n">offset_type</span> <span class="o">==</span> <span class="n">OffsetType</span><span class="o">.</span><span class="n">BYTES</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">byte_href_anchors</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset_type</span> <span class="o">==</span> <span class="n">OffsetType</span><span class="o">.</span><span class="n">CHARS</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">char_href_anchors</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset_type</span> <span class="o">==</span> <span class="n">OffsetType</span><span class="o">.</span><span class="n">LINES</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_href_anchors</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c">## make clean_html accessible as a class property so we can </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_html</span> <span class="o">=</span> <span class="n">clean_html</span>
        <span class="k">for</span> <span class="n">href</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">parser</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">href_filter</span><span class="p">(</span><span class="n">href</span><span class="p">):</span>
                <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                if clean_visible:</span>
<span class="sd">                    _check_html = self.clean_html.splitlines()[first-10:10+first+length]</span>
<span class="sd">                    _check_visi =   clean_visible.splitlines()[first:first+length]</span>
<span class="sd">                    if not make_clean_visible(_check_html) == _check_visi:</span>
<span class="sd">                        print len(self.clean_html.splitlines())</span>
<span class="sd">                        print len(clean_visible.splitlines())</span>

<span class="sd">                        print href</span>
<span class="sd">                        print &#39;\t html: %r&#39; % _check_html</span>
<span class="sd">                        print &#39;\t visi: %r&#39; % _check_visi</span>
<span class="sd">                &#39;&#39;&#39;</span>
                <span class="c">## add a label for every href</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">Label</span><span class="p">(</span>
                    <span class="n">annotator</span> <span class="o">=</span> <span class="n">Annotator</span><span class="p">(</span><span class="n">annotator_id</span> <span class="o">=</span> <span class="s">&#39;author&#39;</span><span class="p">),</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="n">Target</span><span class="p">(</span><span class="n">target_id</span> <span class="o">=</span> <span class="n">href</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="c">## the offset type is specified by the config</span>
                <span class="n">label</span><span class="o">.</span><span class="n">offsets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">offset_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">Offset</span><span class="p">(</span>
                    <span class="n">first</span><span class="o">=</span><span class="n">first</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> 
                    <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                    <span class="c">## the string name of the content field, not the</span>
                    <span class="c">## content itself :-)</span>
                    <span class="n">content_form</span><span class="o">=</span><span class="s">&#39;clean_html&#39;</span><span class="p">)</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">labels</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream_item</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Act as an incremental transform in the kba.pipeline</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c">## right now, we only do clean_html</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;require_clean_html&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stream_item</span><span class="o">.</span><span class="n">body</span> <span class="ow">and</span> <span class="n">stream_item</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">clean_html</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_labels</span><span class="p">(</span><span class="n">stream_item</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">clean_html</span><span class="p">,</span>
                                      <span class="n">stream_item</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">clean_visible</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">labels</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset_type</span> <span class="o">==</span> <span class="n">OffsetType</span><span class="o">.</span><span class="n">LINES</span><span class="p">:</span>
                    <span class="c">## for LINES-type labels, must replace clean_html</span>
                    <span class="c">## with a new one that has newlines inserted</span>
                    <span class="n">stream_item</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">clean_html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_html</span>

                <span class="c">## Remove any previous author labels</span>
                <span class="n">stream_item</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="s">&#39;author&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c">## also add the new labels</span>
                <span class="n">add_annotation</span><span class="p">(</span><span class="n">stream_item</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="o">*</span><span class="n">labels</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stream_item</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">clean_html</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">anchors_re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">clean_html</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;anchor&#39;</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">streamcorpus-pipeline 0.7.10.dev1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-50390027-1', 'streamcorpus.org');
  ga('send', 'pageview');

</script>

  </body>
</html>