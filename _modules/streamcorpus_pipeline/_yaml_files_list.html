<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>streamcorpus_pipeline._yaml_files_list &mdash; streamcorpus-pipeline 0.7.10.dev1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.7.10.dev1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="streamcorpus-pipeline 0.7.10.dev1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">streamcorpus-pipeline 0.7.10.dev1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for streamcorpus_pipeline._yaml_files_list</h1><div class="highlight"><pre>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Transforms a corpus into the streamcorpus format.</span>

<span class="sd">Data is loaded from a yaml file specifying the documents in the</span>
<span class="sd">corpus. The file should contain metadat and a list of documents in the</span>
<span class="sd">body. Example:</span>

<span class="sd">source: &lt;source&gt;</span>
<span class="sd">annotator_id: &lt;annotator_id&gt;</span>
<span class="sd">entities:</span>
<span class="sd">  - target_id: &lt;target_id&gt;</span>
<span class="sd">    external_profiles:</span>
<span class="sd">      - doc_path: &lt;path to file&gt;</span>
<span class="sd">        abs_url: http://...</span>
<span class="sd">    doc_path: &lt;single path to base dir of wget --mirror directory tree&gt;</span>
<span class="sd">      - doc_path: &lt;path to base dir of wget --mirror directory tree&gt;</span>
<span class="sd">      - doc_path: &lt;path to base dir of wget --mirror directory tree&gt;</span>
<span class="sd">      - doc_path: &lt;path to file&gt;</span>
<span class="sd">        abs_url: http://...</span>
<span class="sd">      - doc_path: &lt;path to dir with little structure&gt;</span>
<span class="sd">        abs_url: http://... &lt;will append fragment: #urllib.quote(sub-path)&gt;</span>
<span class="sd">    slots:</span>
<span class="sd">      - slot-name: slot_value</span>
<span class="sd">      - &lt;token&gt;</span>
<span class="sd">      - &lt;token&gt; ... &lt;token&gt;</span>
<span class="sd">  - [...]</span>

<span class="sd">Copyright 2012-2014 Diffeo, Inc.</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">urllib</span>

<span class="kn">import</span> <span class="nn">magic</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="kn">import</span> <span class="nn">streamcorpus</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">streamcorpus_pipeline._clean_visible</span> <span class="kn">import</span> <span class="n">cleanse</span>
<span class="kn">from</span> <span class="nn">streamcorpus_pipeline.stages</span> <span class="kn">import</span> <span class="n">Configured</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="yaml_files_list"><a class="viewcode-back" href="../../sphinx-docs/streamcorpus_pipeline.html#streamcorpus_pipeline._yaml_files_list.yaml_files_list">[docs]</a><span class="k">class</span> <span class="nc">yaml_files_list</span><span class="p">(</span><span class="n">Configured</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Read and tag flat files as described in a YAML file.</span>

<span class="sd">    When this reader stage is in use, the input file to the pipeline</span>
<span class="sd">    is a YAML file.  That YAML file points at several other files and</span>
<span class="sd">    directories, and the contents of those files are emitted as</span>
<span class="sd">    stream items.</span>

<span class="sd">    The YAML file has the following format:</span>

<span class="sd">    .. code-block:: yaml</span>

<span class="sd">        root_path: /data/directory</span>
<span class="sd">        annotator_id: my-name</span>
<span class="sd">        source: weblog</span>
<span class="sd">        entities:</span>
<span class="sd">          - target_id: &quot;https://kb.diffeo.com/sample&quot;</span>
<span class="sd">            doc_path:</span>
<span class="sd">              - sample</span>
<span class="sd">              - doc_path: copies/sample</span>
<span class="sd">                abs_url: &quot;http://source.example.com/sample&quot;</span>
<span class="sd">            external_profiles:</span>
<span class="sd">              - doc_path: wikipedia/Sample</span>
<span class="sd">                abs_url: &quot;http://en.wikipedia.org/wiki/Sample&quot;</span>
<span class="sd">            slots:</span>
<span class="sd">              - canonical_name: Sample</span>
<span class="sd">              - example</span>
<span class="sd">              - title: [Sample, &quot;dot com&quot;]</span>
<span class="sd">              - knowledge_bases:</span>
<span class="sd">                - value: wikipedia</span>
<span class="sd">                - profile_id: &quot;http://en.wikipedia.org/wiki/Sample&quot;</span>
<span class="sd">                - annotator_id: my-name</span>

<span class="sd">    At the top level, the file contains:</span>

<span class="sd">    ``root_path`` (default: current directory)</span>
<span class="sd">      Root path to the data to read.</span>
<span class="sd">    ``annotator_id`` (required)</span>
<span class="sd">      Annotator ID string on produced document ratings.</span>
<span class="sd">    ``source`` (default: ``unknown``)</span>
<span class="sd">      Source type for produced stream items.</span>
<span class="sd">    ``entities`` (required)</span>
<span class="sd">      List of entity document sets to read.</span>

<span class="sd">    ``entities`` is a list of dictionaries.  Each entity dictionary has</span>
<span class="sd">    the following items:</span>

<span class="sd">    ``target_id`` (required)</span>
<span class="sd">      Target entity URL for produced ratings</span>
<span class="sd">    ``doc_path`` (required)</span>
<span class="sd">      List of source files or directories.  These may be strings or</span>
<span class="sd">      dictionaries.  If dictionaries, ``doc_path`` is the filesystem</span>
<span class="sd">      path and ``abs_url`` is the corresponding URL; if strings, the</span>
<span class="sd">      strings are filesystem paths and the URL is generated.</span>
<span class="sd">      Filesystem paths are interpreted relative to the ``root_path``.</span>
<span class="sd">    ``external_profiles`` (optional)</span>
<span class="sd">      List of additional source files or directories that are external</span>
<span class="sd">      profiles, such as Wikipedia articles.  These are processed in</span>
<span class="sd">      the same way as items in ``doc_path`` but must be in dictionary</span>
<span class="sd">      form, where the ``abs_url`` field identifies the external</span>
<span class="sd">      knowledge base article.</span>
<span class="sd">    ``slots`` (required)</span>
<span class="sd">      Additional knowledge base metadata about the entity.</span>

<span class="sd">    For each entity, the reader finds all documents in the named</span>
<span class="sd">    directories and creates a :class:`streamcorpus.StreamItem` for</span>
<span class="sd">    each.  The :attr:`~streamcorpus.StreamItem.body` has its</span>
<span class="sd">    :attr:`~streamcorpus.ContentItem.raw` data set to the contents of</span>
<span class="sd">    the file.  The stream items are also tagged with a</span>
<span class="sd">    :class:`streamcorpus.Rating` where the annotator comes from the</span>
<span class="sd">    file metadata and the target comes from the entity ``target_id``.</span>
<span class="sd">    The :attr:`~streamcorpus.Rating.mentions` on the rating are set</span>
<span class="sd">    to the union of all of the slot values for all slots.</span>

<span class="sd">    The ``slots`` field is a list of values.  Each value is interpreted</span>
<span class="sd">    as follows:</span>

<span class="sd">    1. If it is a dictionary, then each key in the dictionary is</span>
<span class="sd">       interpreted as a slot name, and the corresponding value provides</span>
<span class="sd">       the slot values.  Otherwise, the value is taken as a value for</span>
<span class="sd">       the slot ``NAME``.</span>

<span class="sd">    2. If the slot value is a list, then each item in the list is</span>
<span class="sd">       independently interpreted as a value for this slot.</span>

<span class="sd">    3. If the slot value is a dictionary, then it may have keys</span>
<span class="sd">       ``value`` (required), ``mention_id``, ``profile_id``, and</span>
<span class="sd">       ``annotator_id``, which are used to construct a composite slot</span>
<span class="sd">       value.  Otherwise, the slot value is used directly without</span>
<span class="sd">       additional metadata.</span>

<span class="sd">    The following YAML fragment provides several values for the</span>
<span class="sd">    ``NAME`` slot, which are ultimately combined:</span>

<span class="sd">    .. code-block:: yaml</span>

<span class="sd">        slots:</span>
<span class="sd">          - one</span>
<span class="sd">          - NAME: two</span>
<span class="sd">          - NAME: [three, four]</span>
<span class="sd">          - NAME:</span>
<span class="sd">              value: five</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">config_name</span> <span class="o">=</span> <span class="s">&#39;yaml_files_list&#39;</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_to_input_file</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This _looks_ like a Chunk only in that it generates StreamItem</span>
<span class="sd">        instances when iterated upon.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">path_to_input_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path_to_input_file</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_input_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="c">## read yaml data</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">entities</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;entities&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s">&#39;root_path&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;must specify root_path in yaml file&#39;</span><span class="p">)</span>

        <span class="n">root_path</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s">&#39;root_path&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">root_path</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">root_path</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c">## just as in a regular pipeline config file, root_path</span>
            <span class="c">## empty means use current working dir.</span>
            <span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

        <span class="k">if</span> <span class="s">&#39;source&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;unknown&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;source not set, defaulting to unknown&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s">&#39;annotator_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Invalid labels yaml file: must specify annotator_id&#39;</span><span class="p">)</span>

        <span class="c">## yaml file lists are organized *per* entity, however this</span>
        <span class="c">## must only emit each document once, even if multiple</span>
        <span class="c">## entities are mentioned in the text.  </span>
        <span class="c"># dict keyed on absolute paths in local file system with</span>
        <span class="c"># values as lists of entity records from the original input</span>
        <span class="c"># yaml</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">abs_urls</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
            <span class="c">## get list of file paths to look at</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="n">entity</span><span class="p">[</span><span class="s">&#39;doc_path&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">paths</span><span class="p">]</span>

            <span class="c">## add any external profiles to the paths</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;external_profiles&#39;</span><span class="p">,</span> <span class="p">[]))</span>

            <span class="c">## TODO: put Flags on documents identified as profiles</span>
            <span class="n">external_profiles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ext_profile</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;external_profiles&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">external_profiles</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ext_profile</span><span class="p">[</span><span class="s">&#39;abs_url&#39;</span><span class="p">])</span>

            <span class="c">## For this entity, only touch each documents once.</span>
            <span class="c">## Because the user can specify external_profiles and</span>
            <span class="c">## doc_paths we have the possibility of duplicates.</span>
            <span class="n">visited_paths</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
                <span class="n">abs_url</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">abs_url</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="s">&#39;abs_url&#39;</span><span class="p">]</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="s">&#39;doc_path&#39;</span><span class="p">]</span>

                <span class="c">## normalize path</span>
                <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

                <span class="c">## recurse through directories</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                            <span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">fpath</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited_paths</span><span class="p">:</span>
                                <span class="n">is_profile</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">fpath</span> <span class="ow">in</span> <span class="n">external_profiles</span><span class="p">)</span>
                                <span class="n">sub_path</span> <span class="o">=</span> <span class="n">fpath</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">):]</span>
                                <span class="k">if</span> <span class="n">abs_url</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                                    <span class="c">## construct a URL from the</span>
                                    <span class="c">## sub_path, which works with wget</span>
                                    <span class="c">## --mirror is used to fetch docs</span>
                                    <span class="c">## into a directory</span>
                                    <span class="n">_abs_url</span> <span class="o">=</span> <span class="s">&#39;http://&#39;</span> <span class="o">+</span> <span class="n">sub_path</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c">## display the individual files as</span>
                                    <span class="c">## url fragments, which handles</span>
                                    <span class="c">## the case of a zip archive that</span>
                                    <span class="c">## was manually unpacked </span>
                                    <span class="n">_abs_url</span> <span class="o">=</span> <span class="n">abs_url</span> <span class="o">+</span> <span class="s">&#39;#&#39;</span> <span class="o">+</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">sub_path</span><span class="p">)</span>
                                <span class="n">docs</span><span class="p">[</span><span class="n">fpath</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">entity</span><span class="p">,</span> <span class="n">is_profile</span><span class="p">))</span>
                                <span class="n">abs_urls</span><span class="p">[</span><span class="n">fpath</span><span class="p">]</span> <span class="o">=</span> <span class="n">_abs_url</span>
                                <span class="n">visited_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited_paths</span><span class="p">:</span>
                        <span class="n">is_profile</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">path</span> <span class="ow">in</span> <span class="n">external_profiles</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">abs_url</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;when specifying a full path, you must also specify the abs_url: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
                        <span class="n">docs</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">entity</span><span class="p">,</span> <span class="n">is_profile</span><span class="p">))</span>
                        <span class="n">abs_urls</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">abs_url</span>
                        <span class="n">visited_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c">## multiple mentions per doc have been grouped</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_stream_item</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">abs_urls</span><span class="p">[</span><span class="n">path</span><span class="p">],</span> <span class="n">docs</span><span class="p">[</span><span class="n">path</span><span class="p">])</span>
            

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_parse_slots</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">raw_slots</span><span class="p">):</span>
        <span class="n">slots</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mention</span> <span class="ow">in</span> <span class="n">raw_slots</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mention</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
                <span class="n">mention</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;NAME&#39;</span><span class="p">:</span> <span class="n">mention</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">slotname</span><span class="p">,</span> <span class="n">vl</span> <span class="ow">in</span> <span class="n">mention</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">vl</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vl</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Sequence</span><span class="p">)):</span>
                    <span class="n">vl</span> <span class="o">=</span> <span class="p">[</span><span class="n">vl</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">slotvalue</span> <span class="ow">in</span> <span class="n">vl</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slotvalue</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
                        <span class="n">slotvalue</span> <span class="o">=</span> <span class="n">slotvalue</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]</span>
                    <span class="n">slots</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">slotname</span><span class="p">,</span> <span class="n">slotvalue</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">slots</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_make_stream_item</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">abs_url</span><span class="p">,</span> <span class="n">entities</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c">## Every StreamItem has a stream_time property.  It usually comes</span>
        <span class="c">## from the document creation time.</span>
        <span class="n">creation_time</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getctime</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c">## make stream item</span>
        <span class="n">stream_item</span> <span class="o">=</span> <span class="n">streamcorpus</span><span class="o">.</span><span class="n">make_stream_item</span><span class="p">(</span>
            <span class="n">creation_time</span><span class="p">,</span>
            <span class="n">abs_url</span><span class="p">)</span>

        <span class="n">stream_item</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;source&#39;</span><span class="p">)</span>

        <span class="c">## build a ContentItem for the body</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">streamcorpus</span><span class="o">.</span><span class="n">ContentItem</span><span class="p">()</span>
        <span class="n">body</span><span class="o">.</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">magic</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mime</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;opening </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">body</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="c">## attach the content_item to the stream_item</span>
        <span class="n">stream_item</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>

        <span class="c">## annotations</span>
        <span class="n">anno</span> <span class="o">=</span> <span class="n">streamcorpus</span><span class="o">.</span><span class="n">Annotator</span><span class="p">()</span>
        <span class="n">anno</span><span class="o">.</span><span class="n">annotator_id</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s">&#39;annotator_id&#39;</span><span class="p">]</span>
        <span class="n">anno</span><span class="o">.</span><span class="n">annotation_time</span> <span class="o">=</span> <span class="n">stream_item</span><span class="o">.</span><span class="n">stream_time</span>

        <span class="n">num_ratings</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">entity</span><span class="p">,</span> <span class="n">is_profile</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
            <span class="n">num_ratings</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c">## pull out target id and mention tokens</span>
            <span class="n">target_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">entity</span><span class="p">[</span><span class="s">&#39;target_id&#39;</span><span class="p">])</span>

            <span class="c">## build a Label for the doc-level label:</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="n">streamcorpus</span><span class="o">.</span><span class="n">Rating</span><span class="p">()</span>
            <span class="n">rating</span><span class="o">.</span><span class="n">annotator</span> <span class="o">=</span> <span class="n">anno</span>
            <span class="n">rating</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">streamcorpus</span><span class="o">.</span><span class="n">Target</span><span class="p">(</span><span class="n">target_id</span> <span class="o">=</span> <span class="n">target_id</span><span class="p">)</span>
            <span class="n">rating</span><span class="o">.</span><span class="n">contains_mention</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="k">if</span> <span class="n">is_profile</span><span class="p">:</span>
                <span class="n">rating</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">streamcorpus</span><span class="o">.</span><span class="n">FlagType</span><span class="o">.</span><span class="n">PROFILE</span><span class="p">]</span>

            <span class="c">## parse slots in yaml file</span>
            <span class="n">slots</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_parse_slots</span><span class="p">(</span><span class="n">entity</span><span class="p">[</span><span class="s">&#39;slots&#39;</span><span class="p">])</span>

            <span class="c">## heuristically split the slots string on white space and</span>
            <span class="c">## use each token as a separate mention.</span>
            <span class="n">rating</span><span class="o">.</span><span class="n">mentions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">slots</span><span class="p">:</span>
                <span class="n">mention</span> <span class="o">=</span> <span class="n">slot</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mention</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
                    <span class="n">mention</span> <span class="o">=</span> <span class="n">mention</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span>
                <span class="n">rating</span><span class="o">.</span><span class="n">mentions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mention</span><span class="p">)</span>

            <span class="c">## put this one label in the array of labels</span>
            <span class="n">streamcorpus</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span><span class="n">stream_item</span><span class="p">,</span> <span class="n">rating</span><span class="p">)</span>

        <span class="c">## provide this stream_item to the pipeline</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;created StreamItem(num ratings=</span><span class="si">%d</span><span class="s">, abs_url=</span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">num_ratings</span><span class="p">,</span> <span class="n">stream_item</span><span class="o">.</span><span class="n">abs_url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stream_item</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c">## this is a simple test of this reader stage</span>
    <span class="kn">import</span> <span class="nn">argparse</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;input_dir&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;path to a yaml file with a specification of the corpus.&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">yaml_files_list_instance</span> <span class="o">=</span> <span class="n">yaml_files_list</span><span class="p">({})</span>

    <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">yaml_files_list_instance</span><span class="p">(</span> <span class="n">args</span><span class="o">.</span><span class="n">input_dir</span> <span class="p">):</span>
        <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">raw</span><span class="p">),</span> <span class="n">si</span><span class="o">.</span><span class="n">stream_id</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">streamcorpus-pipeline 0.7.10.dev1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-50390027-1', 'streamcorpus.org');
  ga('send', 'pageview');

</script>

  </body>
</html>